# 005: Supabase Authentication & User Management

**ç‹€æ…‹:** âœ… å·²å¯¦æ–½ (Implemented)
**å„ªå…ˆç´š:** High
**é ä¼°å·¥æœŸ:** ~4 å€‹å·¥ä½œæ—¥
**æœ€å¾Œæ›´æ–°:** 2025-12-20

---

## âš ï¸ é‡è¦æ›´æ–° (2025-12-20)

### React StrictMode + Supabase Lock Deadlock ä¿®å¾©

åœ¨é–‹ç™¼æ¨¡å¼ä¸‹ç™¼ç¾ä¸€å€‹é—œéµå•é¡Œï¼šé é¢æœƒå¡åœ¨ "Loading..." ç‹€æ…‹ã€‚

**æ ¹æœ¬åŸå› ï¼š**
- React StrictMode æœƒé›™é‡æ›è¼‰çµ„ä»¶
- Supabase å®¢æˆ¶ç«¯ä½¿ç”¨ `navigator.locks` API ä¾†ç®¡ç†èªè­‰ç‹€æ…‹
- åŸå§‹çš„ `getSession()` èª¿ç”¨æœƒç²å–ä¸€å€‹é–ï¼Œä½†ç•¶ React å¸è¼‰çµ„ä»¶æ™‚ï¼Œå­¤ç«‹çš„ Promise æ°¸é ä¸æœƒé‡‹æ”¾è©²é–
- é€™å°è‡´å¾ŒçºŒçš„èªè­‰æ“ä½œè¢«é˜»å¡

**è§£æ±ºæ–¹æ¡ˆ (`frontend/src/contexts/AuthContext.tsx`)ï¼š**
1. ç§»é™¤ç›´æ¥çš„ `getSession()` èª¿ç”¨
2. åƒ…ä¾è³´ `onAuthStateChange` çš„ `INITIAL_SESSION` äº‹ä»¶
3. ä½¿ç”¨ç›´æ¥ REST API èª¿ç”¨ä¾†ç²å–ç”¨æˆ¶ profileï¼Œé¿å… Supabase å®¢æˆ¶ç«¯é–ç«¶çˆ­
4. æ·»åŠ  `isMountedRef` ä¾†é˜²æ­¢çµ„ä»¶å¸è¼‰å¾Œçš„ç‹€æ…‹æ›´æ–°

```typescript
// ä½¿ç”¨ç›´æ¥ REST èª¿ç”¨è€Œé Supabase å®¢æˆ¶ç«¯
const response = await fetch(
  `${import.meta.env.VITE_SUPABASE_URL}/rest/v1/profiles?id=eq.${session.user.id}&select=id,display_name,role`,
  {
    headers: {
      'apikey': import.meta.env.VITE_SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${session.access_token}`,
    },
  }
)
```

---

## ğŸ“‹ å¿«é€Ÿæ¦‚è¿°

é€™ä»½ Spec Kit å®šç¾©äº†åœ¨æ•´å€‹ CMS Automation æ‡‰ç”¨ä¸­å°å…¥ Supabase é©—è­‰èˆ‡ä½¿ç”¨è€…ç®¡ç†çš„æ–¹æ¡ˆã€‚æ ¸å¿ƒç›®æ¨™ï¼š

1. **çµ±ä¸€å…¥å£**ï¼šåœ¨é€²å…¥ä»»æ„å‰ç«¯è·¯ç”±å‰é¡¯ç¤ºç™»å…¥é é¢ï¼Œåƒ…æˆæ¬Šç”¨æˆ¶å¯è¨ªå•æ‡‰ç”¨ã€‚
2. **å—ä¿¡ä»»å¾Œç«¯**ï¼šæ‰€æœ‰ API ä»¥ Supabase JWT ç‚ºå”¯ä¸€ä¿¡ä»»ä¾†æºï¼Œå¾Œç«¯ç„¡éœ€ç¶­è­·è‡ªå»º Sessionã€‚
3. **ç°¡åŒ–ç¶­é‹**ï¼šé€é Supabase Dashboard ç®¡ç†å°‘é‡ä½¿ç”¨è€…èˆ‡è§’è‰²ï¼Œé¿å…è¤‡é›œ IAMã€‚
4. **å®‰å…¨é è¨­**ï¼šå¼·åˆ¶ HTTPSã€æœ€å°æ¬Šé™ API Keyã€æœå‹™ç«¯é©—è­‰ + RLSï¼Œé¿å…ç¹éã€‚

---

## ğŸ“š æ–‡æª”å°èˆª

| æ–‡æª” | èªªæ˜ |
|------|------|
| **[requirements.md](./requirements.md)** | åŠŸèƒ½/å®‰å…¨éœ€æ±‚ã€ä½¿ç”¨è€…æ—…ç¨‹ã€æˆåŠŸæŒ‡æ¨™ã€‚ |
| **[plan.md](./plan.md)** | æ¶æ§‹è¨­è¨ˆã€è³‡æ–™æµã€åˆ†éšæ®µå¯¦æ–½èˆ‡é¢¨éšªã€‚ |
| **[tests.md](./tests.md)** | å–®å…ƒ / æ•´åˆ / E2E / æ‰‹å‹•é©—æ”¶çš„æ¸¬è©¦çŸ©é™£ã€‚ |
| **[tasks.md](./tasks.md)** | å¯åŸ·è¡Œä»»å‹™æ¸…å–®ï¼Œå«è¼¸å…¥/è¼¸å‡ºèˆ‡é©—æ”¶æ¢ä»¶ã€‚ |

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

- 100% æœªæˆæ¬Šè«‹æ±‚è¢«æ””æˆªï¼ˆå‰ç«¯è·¯ç”±å®ˆè¡› + å¾Œç«¯ 401ï¼‰ã€‚
- Supabase Email é©—è­‰æˆ–é­”è¡“é€£çµæµç¨‹å…¨é€šéï¼Œå¹³å‡ç™»å…¥è€—æ™‚ < 5 ç§’ã€‚
- 7 å¤©å…§ç„¡é«˜å±å®‰å…¨è­¦ç¤ºï¼ˆSupabase Audit / FastAPI logsï¼‰ã€‚
- æ–°å¢/åœç”¨å¸³è™Ÿå…¨æµç¨‹åƒ…éœ€ Supabase Dashboard + 1 æ¬¡éƒ¨ç½²é…ç½®æ›´æ–°ã€‚

---

## ğŸ§­ é–‹å§‹ä½¿ç”¨

1. ä¾åºé–±è®€ requirements â†’ plan â†’ testsï¼Œç¢ºä¿å°ç¯„åœèˆ‡å¯¦æ–½é †åºæœ‰å…±è­˜ã€‚  
2. ä½¿ç”¨ tasks.md è¿½è¹¤ä»»å‹™é€²åº¦ï¼Œä¸¦åœ¨ MR ä¸­å¼•ç”¨è©²ä»»å‹™ IDã€‚  
3. å°ˆæ¡ˆ `.env` ä¸­è£œé½Š `SUPABASE_URL / ANON_KEY / SERVICE_KEY` å¾Œå³å¯é–‹å§‹é–‹ç™¼ã€‚  
4. é©—æ”¶æ™‚ï¼Œä¾ tests.md çš„æ¸…å–®é€æ¢ç¢ºèªä¸¦é™„ä¸Šæˆªå›¾/éŒ„å±æˆ–æ—¥èªŒã€‚

---

**å¯©æ‰¹:** âœ… å·²å®Œæˆ
**å¯¦æ–½è€…:** Claude Code
**å¯©é–±è€…:** User
**å¯¦æ–½æ—¥æœŸ:** 2025-02-14 (åˆå§‹å¯¦æ–½) / 2025-12-20 (StrictMode ä¿®å¾©)
