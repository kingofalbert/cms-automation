# CMS 校对规则实现逻辑（自然语言解读）

本文以自然语言拆解 `proofreading_requirements.md` v3.1.0 中所有以代码、伪代码、JSON/SQL/PHP 片段呈现的校对与发布合规逻辑，帮助研发与产品成员在不阅读代码的情况下掌握完整实现思路。

---

## 1. 校对服务整体架构

- **统一校对服务 (`ProofreadingService`)**：负责串联 AI 与确定性规则检查。服务会收集所有规则引擎，按配置执行单篇或批量校对，并在需要时触发发布合规验证。
- **规则引擎族群 (`RuleEngine`)**：将校对规则按类别拆成六个子引擎（A 类用字、B 类标点、C 类数字、D 类译名、E 类用词、F 类发布合规），便于独立扩展与维护。
- **规则加载器 (`RuleLoader`)**：支持从 JSON 或数据库加载规则，实现开发环境与生产环境的灵活切换。
- **结果处理模块 (`ProofreadingResult`)**：集中处理自动修正、人工复核提示以及阻断发布的判定。
- **缓存层 (`ProofreadingCache`)**：用于缓存规则或分析结果，减少重复计算。

服务以异步方式提供三大入口：`proofread_article`（单篇校对）、`proofread_batch`（批量校对）与 `validate_publish_ready`（只做 F 类强制验证）。发布验证依赖额外的文章元数据，与语言校对逻辑完全解耦。

---

## 2. 规则引擎与发布验证职责

- **规则引擎基类 (`BaseRuleEngine`)**：统一定义 `check`（找出问题）与 `auto_correct`（自动修正）两类操作，使所有子引擎具备一致接口。
- **发布合规引擎 (`ValidationRuleEngine`)**：新增的 F 类专业引擎，专门检查：
  - 特色图片规格（横图、宽高比、裁剪版本）
  - 文章内插图规格与格式
  - 标题层级（只允许 H2/H3，禁止加粗冒充）
  - 版权信息、授权有效期与合作方格式
  - 关键检查清单（社群素材、置顶需求等）
该引擎产出的每个问题都带有是否阻断发布的标记。

---

## 3. 数据模型说明

- **`ProofreadingIssue`**：描述单条发现的问题，包括规则编号、分类、严重程度、位置、建议修正、置信度与是否阻断发布。
- **`PublishValidationResult`**：发布合规检查的汇总结果，记录是否允许发布、所有问题清单、阻断发布的关键问题、警告以及检查清单勾选状态。
- **`ProofreadingResult`**：单篇文章的综合结果，包含原文、建议稿、问题列表、统计数据、处理耗时与发布合规的附加信息。
- **`ProofreadingStatistics`**：统计各分类与严重程度下的问题数量、自动修正数量、阻断发布标记等。
- **`ArticleMetadata` / `ImageMetadata`**：承载 F 类规则需要的文章结构与图片元数据，例如 HTML 内容、特色图尺寸、裁剪版本、社群图列表、授权来源与到期日等。
- **`ProofreadingConfig`**：运行时配置，决定是否启用自动修正、各类规则、置信度阈值以及是否强制发布验证。
- **`ProofreadingRequest` / `ProofreadingResponse`**：REST API 请求与响应模型。请求可以附带配置与元数据，响应会返回修正后的内容、详细问题与发布合规结果。

---

## 4. 数据库存储设计

- **`proofreading_rules` 表**：保存所有规则定义。关键字段包括 `rule_id`、`category`、规则类型、严重程度、是否可自动修正，以及 `blocks_publish`（是否阻断发布）和 `validation_function`（F 类调用的验证函数名）。
- **`proofreading_history` 表**：记录每次校对的原文、修正稿、问题详情、统计数据、发布验证结果以及最终能否发布，便于追溯。
- **`proofreading_config` 表**：存储可命名的配置方案，可切换启用的规则集合、自动修正选项、置信度阈值与发布验证开关。

---

## 5. API 工作流与数据格式

1. **单篇校对 `POST /api/v1/proofreading/check`**
   - 请求体需要文章内容，可选附带 `metadata`（包含 HTML、小图/大图、社群素材、置顶标记等）与配置。
   - 响应返回原文、修正稿、问题列表、统计信息及 `publish_validation`。若存在阻断发布的问题，`can_publish` 会置为 `false` 并附上错误提示和修复建议。

2. **批量校对 `POST /api/v1/proofreading/check-batch`**
   - 将多篇文章放在 `articles` 数组中处理，共享一份配置，适合作品批量导入或重检。

3. **发布前验证 `POST /api/v1/proofreading/validate-publish`**
   - 仅执行 F 类规则，专用于上线前的强制检查，输出是否可发布与详细问题。

4. **其他辅助接口**
   - `GET /proofreading/rules`：按分类和启用状态查询规则。
   - `PUT /proofreading/config`：更新默认配置。
   - `GET /proofreading/history/{article_id}`：查看单篇历史记录。

---

## 6. F 类发布合规规则解读

### 6.1 F1：图片规格与格式

- **F1-001 通用宽度**：横图必须 600px 宽；方图、竖图 450px；若属特殊版位可降至 450/300px。系统逐张比对宽度，不符即报错。
- **F1-002 特色图横向**：特色图宽高比必须大于 1.2，且不得有白边或大头照。若不满足，立即给出阻断发布的关键问题。
- **F1-003 裁剪完成**：特色图需要具备 mobile、tablet、desktop 三种裁剪版本；缺少任一裁剪都会被拦截。
- **F1-004 置顶分辨率**：若文章标记为置顶，则特色图至少 700×400 像素，否则禁止发布。
- **F1-005 统一 JPG/JPEG**：常规图片必须使用 JPG/JPEG；若检测到 PNG，必须在元数据明确标记允许 PNG 且写明原因。
- **F1-006 社群推广图**：需要社群素材的文章必须提供 700×359 的 Facebook 分享图，并验证尺寸准确。
- **F1-007 图片来源与图说**：图片来源与说明需遵守 E 类规范与授权流程，确保引用信息完整。
- **F1-008 上稿前质量检查**：汇总 F1-001 至 F1-006 的结果，只要存在未修正的问题就禁止上稿。

### 6.2 F2：标题层级与 SEO

- **F2-001 小标只能用 H2/H3**：HTML 中只允许使用 H2（次级标题）与 H3（小节标题），一旦发现 H1/H4/H5/H6 即报错并阻断发布。
- **F2-002 禁止加粗冒充标题**：扫描 `<strong>` 或 `<b>` 标签，如果整段只有加粗文字且长度短，视为标题误用，提示改为正确的 Heading 标签。
- **F2-003 层级顺序清晰**：确保 H3 之前一定出现过 H2，避免结构跳级。

### 6.3 F3：授权与版权

- **F3-001 授权必填**：特色图与所有插图都需要记录授权信息（来源或授权说明），缺少则视为重大违规并阻断发布。
- **F3-002 来源与摄影者**：后台必须填写来源或摄影者字段，确保版权追溯。
- **F3-003 合作方素材格式**：合作媒体（如新唐人）需使用统一格式标注，系统会检查来源是否在白名单内并校验格式。
- **F3-004 授权到期**：若填有授权到期日，系统会对比当前时间，一旦过期立即阻断发布。

### 6.4 F4：后台操作规范

- **F4-001 教材确认**：提醒编辑熟悉最新后台操作教材与教学影片，并在 UI 中提供快捷链接与一键执行 F 类规则的能力（提示性质，不阻断发布）。

### 6.5 F5：上稿检查清单

- **F5-001 Mandatory Checklist**：发布前逐项确认特色图裁剪、社群素材、标题层级、媒体授权等关键项。任何必选项未通过时给出 `can_publish = false` 与详细修复建议。

### 6.6 F6：可自动检核的规则

- **F6-001 特色图自动检查**：综合宽高比、格式、裁剪版本三个条件，一旦不符立即给出阻断发布的关键问题。
- **F6-002 插图规格自动检查**：遍历所有插图，判断横/方/竖图对应的标准宽度，同时检查 PNG 使用是否已说明原因。
- **F6-003 社群素材自动检查**：在需要社群素材的场景下确认 Facebook 专用图是否存在且尺寸精准。
- **F6-004 标题层级自动检查**：解析 HTML，确认只有 H2/H3，且没有使用 `<strong>` 伪造标题。
- **F6-005 授权信息自动检查**：核对来源/摄影者填写情况、合作方标注格式与授权是否过期。
- **F6-006 发布阻断判定**：综合所有验证结果，只要出现 `severity=critical` 或会阻断发布的 `error`，就判定不可发布；否则返回可发布。

---

## 7. 规则存储与配置

- **JSON 存储示例**：每条规则包含 `rule_id`、分类、正则模式或验证函数、替换内容、是否可自动修正、置信度与示例等字段，方便在研发阶段快速迭代。
- **F 类规则示例**：通过 `rule_type=validation` 与 `validation_function` 映射到具体的验证逻辑，同时标记 `blocks_publish=true`，确保运行时能调用自动检查函数。
- **数据库方案**：生产环境推荐将规则存入数据库，可启用/停用、调整优先级、做版本管理，并通过 API 下发给服务实例。

---

## 8. 校对处理流程（运行时）

1. **预处理**：清理文本、按段落拆分，避免跨段误判。
2. **语言校对**：遍历段落，按配置启用 A–E 类规则引擎；若开启自动修正且置信度足够，就直接替换文本。
3. **发布合规验证**：当配置要求并且提供了文章元数据时，调用 `ValidationRuleEngine` 执行 F 类检查，将所有问题合并进总列表。
4. **统计生成**：计算总问题数、各分类计数、阻断发布数量等，回填到 `ProofreadingStatistics`。
5. **发布判定**：如果存在合规检查结果，就读取 `can_publish`；否则默认允许发布。

---

## 9. 版本管理与工作流

- **多版本字段**：数据库新增原始、建议、最终三组内容及元数据字段，以便保存 AI 建议稿、FAQ Schema、用户修改记录等。
- **工作流状态机**：文章从 `pending` 进入解析、分析、生成建议，再到用户审核/编辑，最终确认与发布。状态机保证每一步有迹可循，也能触发相应的任务（如重新校对）。

---

## 10. 技术栈与外部集成

- **主要依赖**：正则处理（`re`）、中文分词（`jieba`）、HTML 解析（`BeautifulSoup`）、图像处理（`Pillow`）、NLP 模型（`transformers`，可选）、数据库访问（`SQLAlchemy`）、缓存（`Redis`）与时间处理（`datetime`）。
- **WordPress 集成**：FAQ Schema 通过 `add_post_meta` 写入文章元数据，并在 `<head>` 注入 JSON-LD，必要时可在文章底部渲染可折叠的 FAQ 区块，兼顾 SEO 与用户体验。

---

## 11. 开发节奏与优先级

- **MVP 阶段**：优先实现 A1、A3、B2、C1 等确定性强、自动修正安全的规则。
- **核心阶段**：扩展易混淆字、报导用词、引号/书名号等中等复杂度规则。
- **发布合规阶段**：补齐 F 类规则、发布阻断能力与自动化检查。
- **扩展阶段**：完善剩余 A–E 类规则、引入 FAQ Schema、结构化 SEO 功能，并与前端/WordPress 深度联动。

---

通过以上自然语言解读，可以在不直接阅读代码的前提下，完整理解 CMS 校对系统的架构、数据模型、API、规则实施与发布合规策略，为后续开发、测试与运营提供统一认知基础。
