# T7.3.1 規則審查與修改 API 設計文檔

## 1. 功能概述

提供用戶審查、修改和確認學習規則的完整工作流程，支持自然語言編輯和代碼生成。

## 2. 新增 API 端點

### 2.1 規則草稿管理

#### 2.1.1 保存規則為草稿
```
POST /api/v1/proofreading/decisions/rules/draft
```

**請求體:**
```json
{
  "rules": [
    {
      "rule_id": "replace_001",
      "rule_type": "replacement",
      "pattern": "錯別字",
      "replacement": "錯誤字",
      "confidence": 0.92
    }
  ],
  "description": "從最近決策中提取的規則",
  "metadata": {
    "generation_date": "2024-11-03T10:00:00Z",
    "source": "pattern_analysis",
    "total_decisions_analyzed": 500
  }
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "draft_id": "draft_20241103_001",
    "rule_count": 15,
    "status": "pending_review",
    "created_at": "2024-11-03T10:00:00Z"
  }
}
```

#### 2.1.2 獲取待審查規則列表
```
GET /api/v1/proofreading/decisions/rules/drafts
```

**查詢參數:**
- `status`: 狀態篩選 (pending_review|in_review|approved|rejected)
- `page`: 頁碼
- `limit`: 每頁數量

**響應:**
```json
{
  "success": true,
  "data": {
    "drafts": [
      {
        "draft_id": "draft_20241103_001",
        "rule_count": 15,
        "status": "pending_review",
        "description": "從最近決策中提取的規則",
        "created_at": "2024-11-03T10:00:00Z",
        "created_by": "system",
        "review_progress": {
          "total": 15,
          "reviewed": 0,
          "approved": 0,
          "modified": 0,
          "rejected": 0
        }
      }
    ],
    "total": 5,
    "page": 1,
    "limit": 20
  }
}
```

### 2.2 規則審查與修改

#### 2.2.1 獲取草稿詳情
```
GET /api/v1/proofreading/decisions/rules/drafts/{draft_id}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "draft_id": "draft_20241103_001",
    "status": "in_review",
    "rules": [
      {
        "rule_id": "replace_001",
        "rule_type": "replacement",
        "natural_language": "當遇到「錯別字」時，建議替換為「錯誤字」",
        "pattern": "錯別字",
        "replacement": "錯誤字",
        "confidence": 0.92,
        "examples": [
          {
            "before": "文章中有錯別字",
            "after": "文章中有錯誤字"
          }
        ],
        "review_status": "pending",
        "user_feedback": null
      }
    ],
    "metadata": {
      "generation_date": "2024-11-03T10:00:00Z",
      "source": "pattern_analysis",
      "total_decisions_analyzed": 500
    }
  }
}
```

#### 2.2.2 使用自然語言修改規則
```
PUT /api/v1/proofreading/decisions/rules/drafts/{draft_id}/rules/{rule_id}
```

**請求體:**
```json
{
  "natural_language": "當看到「因此」在段落開頭時，建議改為「所以」，但如果是正式文件則保留",
  "examples": [
    {
      "before": "因此，我們決定...",
      "after": "所以，我們決定..."
    }
  ],
  "conditions": {
    "document_type": "informal",
    "position": "paragraph_start"
  }
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "rule_id": "replace_001",
    "natural_language": "當看到「因此」在段落開頭時，建議改為「所以」，但如果是正式文件則保留",
    "generated_code": {
      "pattern": "^因此",
      "replacement": "所以",
      "conditions": [
        {
          "type": "document_type",
          "operator": "equals",
          "value": "informal"
        },
        {
          "type": "position",
          "operator": "equals",
          "value": "paragraph_start"
        }
      ]
    },
    "validation": {
      "syntax_valid": true,
      "testable": true,
      "warnings": []
    }
  }
}
```

#### 2.2.3 批量審查規則
```
POST /api/v1/proofreading/decisions/rules/drafts/{draft_id}/review
```

**請求體:**
```json
{
  "reviews": [
    {
      "rule_id": "replace_001",
      "action": "approve",
      "comment": "規則準確"
    },
    {
      "rule_id": "replace_002",
      "action": "modify",
      "natural_language": "只在非正式文檔中應用此規則",
      "comment": "需要考慮文檔類型"
    },
    {
      "rule_id": "replace_003",
      "action": "reject",
      "comment": "此規則過於嚴格"
    }
  ]
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "processed": 3,
    "approved": 1,
    "modified": 1,
    "rejected": 1,
    "draft_status": "partially_reviewed"
  }
}
```

### 2.3 規則確認與發布

#### 2.3.1 確認並發布規則集
```
POST /api/v1/proofreading/decisions/rules/drafts/{draft_id}/publish
```

**請求體:**
```json
{
  "name": "2024年11月校對規則集",
  "description": "基於最近500個決策生成的規則",
  "include_rejected": false,
  "activation_date": "2024-11-04T00:00:00Z",
  "test_mode": false
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "ruleset_id": "ruleset_20241103_001",
    "name": "2024年11月校對規則集",
    "total_rules": 12,
    "approved_rules": 10,
    "modified_rules": 2,
    "status": "published",
    "activation_date": "2024-11-04T00:00:00Z",
    "code_generation": {
      "success": true,
      "compiled_rules": "/api/v1/proofreading/rules/compiled/ruleset_20241103_001"
    }
  }
}
```

#### 2.3.2 獲取編譯後的規則代碼
```
GET /api/v1/proofreading/decisions/rules/compiled/{ruleset_id}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "ruleset_id": "ruleset_20241103_001",
    "version": "1.0.0",
    "compiled_at": "2024-11-03T10:30:00Z",
    "rules": [
      {
        "id": "rule_001",
        "type": "regex_replacement",
        "code": {
          "pattern": "/錯別字/g",
          "replacement": "錯誤字",
          "conditions": [],
          "priority": 100
        },
        "metadata": {
          "source": "user_approved",
          "confidence": 0.92
        }
      }
    ],
    "execution_config": {
      "parallel_execution": true,
      "max_iterations": 1,
      "conflict_resolution": "priority_based"
    }
  }
}
```

### 2.4 規則測試

#### 2.4.1 測試規則集
```
POST /api/v1/proofreading/decisions/rules/test
```

**請求體:**
```json
{
  "ruleset_id": "ruleset_20241103_001",
  "test_content": "這段文字包含錯別字，因此需要修正。",
  "options": {
    "show_step_by_step": true,
    "apply_conditions": true
  }
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "original": "這段文字包含錯別字，因此需要修正。",
    "result": "這段文字包含錯誤字，所以需要修正。",
    "changes": [
      {
        "rule_id": "rule_001",
        "type": "replacement",
        "position": [7, 10],
        "original": "錯別字",
        "replacement": "錯誤字",
        "confidence": 0.92
      },
      {
        "rule_id": "rule_002",
        "type": "replacement",
        "position": [11, 13],
        "original": "因此",
        "replacement": "所以",
        "confidence": 0.85
      }
    ],
    "execution_time_ms": 15
  }
}
```

### 2.5 規則版本管理

#### 2.5.1 獲取規則版本歷史
```
GET /api/v1/proofreading/decisions/rules/history
```

**查詢參數:**
- `ruleset_id`: 規則集ID（可選）
- `start_date`: 開始日期
- `end_date`: 結束日期

**響應:**
```json
{
  "success": true,
  "data": {
    "versions": [
      {
        "ruleset_id": "ruleset_20241103_001",
        "version": "1.0.0",
        "name": "2024年11月校對規則集",
        "rule_count": 12,
        "status": "active",
        "published_at": "2024-11-03T10:30:00Z",
        "published_by": "admin",
        "usage_stats": {
          "total_applications": 1523,
          "acceptance_rate": 0.87
        }
      }
    ],
    "total": 5
  }
}
```

#### 2.5.2 回滾到特定版本
```
POST /api/v1/proofreading/decisions/rules/rollback
```

**請求體:**
```json
{
  "target_ruleset_id": "ruleset_20241102_001",
  "reason": "新版本規則導致誤判增加"
}
```

## 3. 數據模型更新

### 3.1 RuleDraft 模型
```python
class RuleDraft(BaseModel):
    """規則草稿模型"""
    draft_id: str
    rules: List[DraftRule]
    status: DraftStatus  # pending_review, in_review, approved, rejected
    description: Optional[str]
    metadata: Dict[str, Any]
    created_at: datetime
    created_by: str
    review_progress: ReviewProgress

class DraftRule(BaseModel):
    """草稿中的規則"""
    rule_id: str
    rule_type: str
    natural_language: str
    pattern: Optional[str]
    replacement: Optional[str]
    conditions: Optional[Dict[str, Any]]
    confidence: float
    examples: List[Example]
    review_status: ReviewStatus  # pending, approved, modified, rejected
    user_feedback: Optional[str]
    modified_at: Optional[datetime]
    modified_by: Optional[str]

class ReviewProgress(BaseModel):
    """審查進度"""
    total: int
    reviewed: int
    approved: int
    modified: int
    rejected: int
```

### 3.2 RuleSet 模型
```python
class RuleSet(BaseModel):
    """已發布的規則集"""
    ruleset_id: str
    name: str
    version: str
    rules: List[CompiledRule]
    status: RuleSetStatus  # draft, published, active, deprecated
    published_at: datetime
    published_by: str
    activation_date: Optional[datetime]

class CompiledRule(BaseModel):
    """編譯後的規則"""
    id: str
    type: str
    code: Dict[str, Any]  # 可執行的規則代碼
    natural_language: str  # 自然語言描述
    metadata: RuleMetadata
```

## 4. 自然語言處理邏輯

### 4.1 自然語言轉換為規則代碼
```python
async def natural_language_to_rule(
    nl_description: str,
    examples: List[Example],
    rule_type: Optional[str] = None
) -> CompiledRule:
    """將自然語言描述轉換為可執行規則"""

    # 1. 解析自然語言
    parsed = parse_natural_language(nl_description)

    # 2. 提取模式和動作
    pattern = extract_pattern(parsed, examples)
    action = extract_action(parsed)
    conditions = extract_conditions(parsed)

    # 3. 生成規則代碼
    rule_code = generate_rule_code(
        pattern=pattern,
        action=action,
        conditions=conditions,
        rule_type=rule_type
    )

    # 4. 驗證規則
    validation = validate_rule(rule_code, examples)

    return CompiledRule(
        id=generate_rule_id(),
        type=rule_type or infer_rule_type(pattern, action),
        code=rule_code,
        natural_language=nl_description,
        metadata=RuleMetadata(
            confidence=validation.confidence,
            validated=validation.success
        )
    )
```

### 4.2 規則代碼生成器
```python
def generate_rule_code(
    pattern: str,
    action: str,
    conditions: Optional[List[Condition]] = None,
    rule_type: str = "replacement"
) -> Dict[str, Any]:
    """生成可執行的規則代碼"""

    if rule_type == "replacement":
        return {
            "pattern": compile_pattern(pattern),
            "replacement": action,
            "conditions": compile_conditions(conditions),
            "priority": calculate_priority(pattern, conditions)
        }
    elif rule_type == "suggestion":
        return {
            "trigger": compile_pattern(pattern),
            "suggestion": action,
            "confidence_threshold": 0.7,
            "conditions": compile_conditions(conditions)
        }
    # ... 其他規則類型
```

## 5. UI 整合建議

### 5.1 規則審查界面
- 規則列表視圖，顯示所有待審查規則
- 自然語言編輯器，支持實時預覽
- 測試面板，可立即測試規則效果
- 批量操作功能

### 5.2 工作流程
1. 系統自動生成規則草稿
2. 用戶在 UI 中審查規則
3. 使用自然語言修改規則
4. 測試規則效果
5. 確認並發布規則集
6. 監控規則應用效果

## 6. 安全考慮

1. **規則驗證**: 所有規則在發布前必須通過語法和邏輯驗證
2. **權限控制**: 只有授權用戶可以發布規則
3. **審計日誌**: 記錄所有規則修改歷史
4. **回滾機制**: 支持快速回滾到之前版本
5. **沙箱測試**: 在隔離環境中測試規則

## 7. 性能優化

1. **規則緩存**: 緩存編譯後的規則以提高執行效率
2. **增量更新**: 只更新修改的規則
3. **並行處理**: 支持並行執行多個規則
4. **優先級隊列**: 根據置信度和優先級執行規則