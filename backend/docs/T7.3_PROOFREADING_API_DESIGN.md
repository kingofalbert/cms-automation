# T7.3 校對決策 API 設計文檔

## 1. API 概述

校對決策 API 提供 RESTful 接口，用於管理校對決策的完整生命週期，包括決策記錄、查詢、模式分析和規則學習。

### 1.1 基礎路徑
```
/api/v1/proofreading/decisions
```

### 1.2 認證
- Bearer Token 認證（可選）
- API Key 認證（可選）

### 1.3 通用響應格式
```json
{
  "success": true,
  "data": {...},
  "message": "操作成功",
  "timestamp": "2024-11-02T10:00:00Z"
}
```

### 1.4 錯誤響應格式
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "錯誤描述",
    "details": {...}
  },
  "timestamp": "2024-11-02T10:00:00Z"
}
```

## 2. API 端點定義

### 2.1 決策記錄端點

#### 2.1.1 記錄單個決策
```
POST /api/v1/proofreading/decisions
```

**請求體:**
```json
{
  "article_id": 123,
  "proofreading_history_id": 456,
  "suggestion_id": "sug_001",
  "decision": "accept|reject|modify",
  "custom_correction": "自定義修正內容",
  "decision_reason": "決策原因",
  "tags": ["spelling", "grammar"]
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "decision_id": 789,
    "article_id": 123,
    "suggestion_id": "sug_001",
    "decision": "accept",
    "confidence_score": 0.85,
    "created_at": "2024-11-02T10:00:00Z"
  }
}
```

#### 2.1.2 批量記錄決策
```
POST /api/v1/proofreading/decisions/batch
```

**請求體:**
```json
{
  "article_id": 123,
  "proofreading_history_id": 456,
  "decisions": [
    {
      "suggestion_id": "sug_001",
      "decision": "accept",
      "reason": "拼寫正確"
    },
    {
      "suggestion_id": "sug_002",
      "decision": "reject",
      "reason": "保持原樣"
    }
  ]
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "processed": 2,
    "successful": 2,
    "failed": 0,
    "decisions": [...]
  }
}
```

### 2.2 決策查詢端點

#### 2.2.1 獲取文章決策
```
GET /api/v1/proofreading/decisions/article/{article_id}
```

**查詢參數:**
- `include_history`: 是否包含校對歷史（默認 false）
- `page`: 頁碼（默認 1）
- `limit`: 每頁數量（默認 20）

**響應:**
```json
{
  "success": true,
  "data": {
    "decisions": [...],
    "total": 50,
    "page": 1,
    "limit": 20
  }
}
```

#### 2.2.2 獲取決策詳情
```
GET /api/v1/proofreading/decisions/{decision_id}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "decision_id": 789,
    "article_id": 123,
    "suggestion_type": "spelling",
    "original_text": "錯別字",
    "suggested_text": "錯誤字",
    "decision": "accept",
    "custom_correction": null,
    "decision_reason": "拼寫錯誤",
    "confidence_score": 0.85,
    "context_before": "這是",
    "context_after": "的例子",
    "tags": ["spelling"],
    "created_at": "2024-11-02T10:00:00Z",
    "updated_at": "2024-11-02T10:00:00Z"
  }
}
```

#### 2.2.3 查詢決策歷史
```
GET /api/v1/proofreading/decisions/history
```

**查詢參數:**
- `user_id`: 用戶 ID（可選）
- `start_date`: 開始日期
- `end_date`: 結束日期
- `decision_type`: 決策類型（accept|reject|modify）
- `suggestion_type`: 建議類型
- `page`: 頁碼
- `limit`: 每頁數量

### 2.3 模式分析端點

#### 2.3.1 分析決策模式
```
GET /api/v1/proofreading/decisions/patterns/analyze
```

**查詢參數:**
- `start_date`: 開始日期
- `end_date`: 結束日期
- `min_occurrences`: 最小出現次數（默認 5）

**響應:**
```json
{
  "success": true,
  "data": {
    "common_acceptances": [
      {
        "pattern_type": "spelling",
        "frequency": 25,
        "rate": 0.92,
        "confidence": 0.95,
        "examples": ["錯別字->錯誤字", "語法->文法"]
      }
    ],
    "common_rejections": [
      {
        "pattern_type": "punctuation",
        "frequency": 15,
        "rate": 0.88,
        "confidence": 0.90
      }
    ],
    "custom_corrections": [
      {
        "original_pattern": "例如",
        "correction_pattern": "比如",
        "frequency": 8,
        "confidence": 0.85
      }
    ],
    "time_patterns": [
      {
        "period": "daily",
        "trend": "increasing",
        "metrics": {
          "avg_daily_decisions": 45,
          "max_daily_decisions": 120
        }
      }
    ]
  }
}
```

#### 2.3.2 提取用戶偏好
```
GET /api/v1/proofreading/decisions/preferences/{user_id}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "style_preferences": {
      "formal_level": "formal",
      "sentence_length": "medium",
      "complexity": "moderate"
    },
    "vocabulary_preferences": ["因此", "並且", "然而"],
    "grammar_rules": ["避免被動語態", "使用簡潔表達"],
    "punctuation_habits": {
      "list_style": "semicolon",
      "quote_style": "double"
    },
    "confidence_level": 0.85
  }
}
```

### 2.4 規則學習端點

#### 2.4.1 生成學習規則
```
POST /api/v1/proofreading/decisions/rules/generate
```

**請求體:**
```json
{
  "confidence_threshold": 0.8,
  "include_patterns": true,
  "include_preferences": true
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "rules": [
      {
        "rule_id": "replace_001",
        "rule_type": "replacement",
        "pattern": "錯別字",
        "replacement": "錯誤字",
        "confidence": 0.92,
        "example_applications": [...]
      }
    ],
    "total_rules": 15,
    "generation_timestamp": "2024-11-02T10:00:00Z"
  }
}
```

#### 2.4.2 應用學習規則
```
POST /api/v1/proofreading/decisions/rules/apply
```

**請求體:**
```json
{
  "content": "這是包含錯別字的文本",
  "rule_ids": ["replace_001", "style_002"],
  "apply_all": false
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "original_content": "這是包含錯別字的文本",
    "modified_content": "這是包含錯誤字的文本",
    "applications": [
      {
        "rule_id": "replace_001",
        "original_text": "錯別字",
        "modified_text": "錯誤字",
        "position": [8, 11],
        "confidence": 0.92
      }
    ],
    "total_changes": 1
  }
}
```

### 2.5 反饋聚合端點

#### 2.5.1 獲取反饋統計
```
GET /api/v1/proofreading/decisions/feedback/stats
```

**查詢參數:**
- `aggregation_period`: daily|weekly|monthly
- `date`: 指定日期

**響應:**
```json
{
  "success": true,
  "data": {
    "total_decisions": 150,
    "acceptance_rate": 0.72,
    "rejection_rate": 0.18,
    "modification_rate": 0.10,
    "suggestion_type_distribution": {
      "spelling": 45,
      "grammar": 38,
      "punctuation": 32,
      "style": 35
    },
    "user_activity": {
      "unique_articles": 25,
      "avg_decisions_per_article": 6
    },
    "time_period": "daily_2024-11-02"
  }
}
```

#### 2.5.2 準備調優數據集
```
POST /api/v1/proofreading/decisions/feedback/prepare-dataset
```

**請求體:**
```json
{
  "min_examples": 100,
  "balance_dataset": true,
  "include_metadata": true
}
```

**響應:**
```json
{
  "success": true,
  "data": {
    "dataset_id": "ds_20241102_001",
    "positive_examples": 120,
    "negative_examples": 120,
    "custom_examples": 35,
    "metadata": {
      "creation_date": "2024-11-02T10:00:00Z",
      "total_decisions": 275,
      "balance_applied": true
    },
    "download_url": "/api/v1/proofreading/datasets/ds_20241102_001"
  }
}
```

### 2.6 質量評估端點

#### 2.6.1 評估建議質量
```
GET /api/v1/proofreading/decisions/quality/evaluate
```

**查詢參數:**
- `start_date`: 開始日期
- `end_date`: 結束日期

**響應:**
```json
{
  "success": true,
  "data": {
    "accuracy": 0.82,
    "relevance": 0.78,
    "usefulness": 0.85,
    "trend": "improving",
    "details": {
      "total_decisions": 500,
      "accepted": 410,
      "rejected": 60,
      "modified": 30,
      "avg_confidence": 0.83
    }
  }
}
```

#### 2.6.2 識別改進領域
```
GET /api/v1/proofreading/decisions/quality/improvements
```

**查詢參數:**
- `target_accuracy`: 目標準確率（默認 0.85）

**響應:**
```json
{
  "success": true,
  "data": {
    "improvement_areas": [
      {
        "area_name": "建議準確率",
        "current_performance": 0.82,
        "target_performance": 0.85,
        "priority": "high",
        "suggestions": [
          "分析被拒絕的建議模式",
          "調整建議生成算法",
          "增加上下文考慮"
        ]
      }
    ],
    "total_areas": 3
  }
}
```

### 2.7 管理端點

#### 2.7.1 更新決策
```
PUT /api/v1/proofreading/decisions/{decision_id}
```

**請求體:**
```json
{
  "decision": "modify",
  "custom_correction": "新的修正內容",
  "decision_reason": "更新原因"
}
```

#### 2.7.2 刪除決策
```
DELETE /api/v1/proofreading/decisions/{decision_id}
```

#### 2.7.3 清除緩存
```
POST /api/v1/proofreading/decisions/cache/clear
```

## 3. 數據模型定義

### 3.1 請求模型

```python
# Pydantic 模型定義

class DecisionRequest(BaseModel):
    """決策請求模型"""
    article_id: int
    proofreading_history_id: int
    suggestion_id: str
    decision: DecisionType
    custom_correction: Optional[str] = None
    decision_reason: Optional[str] = None
    tags: Optional[List[str]] = None

class BatchDecisionRequest(BaseModel):
    """批量決策請求"""
    article_id: int
    proofreading_history_id: int
    decisions: List[DecisionInput]

class RuleApplicationRequest(BaseModel):
    """規則應用請求"""
    content: str
    rule_ids: Optional[List[str]] = None
    apply_all: bool = False
```

### 3.2 響應模型

```python
class DecisionResponse(BaseModel):
    """決策響應模型"""
    decision_id: int
    article_id: int
    suggestion_id: str
    decision: DecisionType
    confidence_score: float
    created_at: datetime

class PatternAnalysisResponse(BaseModel):
    """模式分析響應"""
    common_acceptances: List[PatternDetail]
    common_rejections: List[PatternDetail]
    custom_corrections: List[CorrectionPattern]
    time_patterns: List[TimePattern]

class QualityEvaluationResponse(BaseModel):
    """質量評估響應"""
    accuracy: float
    relevance: float
    usefulness: float
    trend: str
    details: Dict[str, Any]
```

## 4. 錯誤碼定義

| 錯誤碼 | 描述 | HTTP 狀態碼 |
|--------|------|-------------|
| INVALID_DECISION | 無效的決策類型 | 400 |
| DECISION_NOT_FOUND | 決策不存在 | 404 |
| DUPLICATE_DECISION | 重複的決策 | 409 |
| ARTICLE_NOT_FOUND | 文章不存在 | 404 |
| HISTORY_NOT_FOUND | 校對歷史不存在 | 404 |
| PATTERN_ANALYSIS_FAILED | 模式分析失敗 | 500 |
| INSUFFICIENT_DATA | 數據不足 | 400 |
| UNAUTHORIZED | 未授權 | 401 |
| RATE_LIMITED | 請求頻率限制 | 429 |

## 5. API 限流策略

- 標準用戶: 100 請求/分鐘
- 高級用戶: 500 請求/分鐘
- 批量操作: 10 請求/分鐘

## 6. 緩存策略

- 模式分析結果: 緩存 1 小時
- 用戶偏好: 緩存 30 分鐘
- 質量評估: 緩存 15 分鐘
- 統計數據: 緩存 5 分鐘

## 7. 安全考慮

1. **輸入驗證**: 所有輸入必須經過驗證和清理
2. **SQL 注入防護**: 使用參數化查詢
3. **XSS 防護**: 對輸出進行編碼
4. **CSRF 防護**: 使用 CSRF token
5. **速率限制**: 防止濫用

## 8. 性能優化

1. **數據庫索引**:
   - (article_id, created_at)
   - (suggestion_type, decision)
   - (user_id, created_at)

2. **分頁查詢**: 所有列表端點支持分頁

3. **異步處理**: 耗時操作使用異步任務

4. **連接池**: 使用數據庫連接池

## 9. 監控指標

- API 響應時間
- 錯誤率
- 請求量
- 緩存命中率
- 數據庫查詢時間

## 10. 版本控制

- 當前版本: v1
- 向後兼容: 保證主版本內向後兼容
- 棄用策略: 提前 3 個月通知