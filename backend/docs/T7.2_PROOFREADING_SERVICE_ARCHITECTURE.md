# T7.2 校對決策服務架構設計

## 1. 服務概述

校對決策服務（ProofreadingDecisionService）是 T7 系統的核心業務邏輯層，負責處理校對決策的記錄、分析和學習。

### 1.1 核心職責
- **決策記錄**: 持久化用戶對校對建議的決策
- **模式識別**: 分析歷史決策，識別用戶偏好模式
- **反饋聚合**: 統計決策數據，生成學習數據集
- **規則提取**: 從決策模式中提取可重用的規則
- **質量改進**: 基於反饋優化未來的校對建議

## 2. 服務架構

```python
# src/services/proofreading_decision.py

class ProofreadingDecisionService:
    """校對決策服務

    處理校對決策的完整生命週期：
    1. 記錄決策
    2. 分析模式
    3. 提取規則
    4. 優化建議
    """

    def __init__(self):
        self.logger = get_logger(__name__)
        self.min_pattern_threshold = 5  # 形成模式的最小決策數
        self.confidence_threshold = 0.8  # 規則置信度閾值
```

## 3. 核心方法設計

### 3.1 決策記錄方法

```python
async def record_decision(
    self,
    session: AsyncSession,
    article_id: int,
    proofreading_history_id: int,
    suggestion_id: str,
    decision: DecisionType,
    custom_correction: Optional[str] = None,
    decision_reason: Optional[str] = None,
    tags: Optional[List[str]] = None
) -> ProofreadingDecision:
    """記錄單個校對決策"""
    pass

async def record_batch_decisions(
    self,
    session: AsyncSession,
    article_id: int,
    decisions: List[DecisionInput]
) -> List[ProofreadingDecision]:
    """批量記錄多個決策"""
    pass
```

### 3.2 決策查詢方法

```python
async def get_article_decisions(
    self,
    session: AsyncSession,
    article_id: int,
    include_history: bool = False
) -> List[ProofreadingDecision]:
    """獲取文章的所有決策記錄"""
    pass

async def get_user_decision_history(
    self,
    session: AsyncSession,
    user_id: Optional[int] = None,
    limit: int = 100,
    offset: int = 0
) -> List[ProofreadingDecision]:
    """獲取用戶的決策歷史"""
    pass
```

### 3.3 模式分析方法

```python
async def analyze_decision_patterns(
    self,
    session: AsyncSession,
    time_range: Optional[DateRange] = None,
    min_occurrences: int = 5
) -> DecisionPatterns:
    """分析決策模式

    Returns:
        DecisionPatterns: 包含:
        - common_acceptances: 常接受的建議類型
        - common_rejections: 常拒絕的建議類型
        - custom_correction_patterns: 自定義修正模式
        - time_based_patterns: 基於時間的模式
    """
    pass

async def extract_user_preferences(
    self,
    session: AsyncSession,
    user_id: Optional[int] = None
) -> UserPreferences:
    """提取用戶偏好

    分析用戶的歷史決策，提取：
    - 寫作風格偏好
    - 詞彙使用偏好
    - 語法規則偏好
    - 標點符號習慣
    """
    pass
```

### 3.4 規則學習方法

```python
async def generate_learning_rules(
    self,
    session: AsyncSession,
    patterns: DecisionPatterns,
    confidence_threshold: float = 0.8
) -> List[LearningRule]:
    """從模式生成學習規則

    將決策模式轉換為可執行的規則：
    - IF-THEN 規則
    - 正則表達式替換規則
    - 上下文相關規則
    """
    pass

async def apply_learning_rules(
    self,
    content: str,
    rules: List[LearningRule]
) -> Tuple[str, List[RuleApplication]]:
    """應用學習規則到新內容"""
    pass
```

### 3.5 反饋聚合方法

```python
async def aggregate_feedback_data(
    self,
    session: AsyncSession,
    aggregation_period: str = "daily"
) -> FeedbackAggregation:
    """聚合反饋數據

    統計指標：
    - 總決策數
    - 接受率/拒絕率
    - 自定義修正率
    - 建議類型分布
    - 用戶活躍度
    """
    pass

async def prepare_tuning_dataset(
    self,
    session: AsyncSession,
    min_examples: int = 100
) -> TuningDataset:
    """準備模型微調數據集

    從決策歷史中生成訓練數據：
    - 正例：接受的建議
    - 負例：拒絕的建議
    - 自定義例：用戶修正
    """
    pass
```

### 3.6 質量評估方法

```python
async def evaluate_suggestion_quality(
    self,
    session: AsyncSession,
    time_range: Optional[DateRange] = None
) -> QualityMetrics:
    """評估校對建議質量

    計算指標：
    - 準確率：接受率
    - 相關性：建議與內容的相關度
    - 有用性：實際應用率
    - 改進趨勢：質量變化趨勢
    """
    pass

async def identify_improvement_areas(
    self,
    session: AsyncSession,
    quality_metrics: QualityMetrics
) -> List[ImprovementArea]:
    """識別需要改進的領域"""
    pass
```

## 4. 數據模型

### 4.1 輸入模型

```python
@dataclass
class DecisionInput:
    """決策輸入"""
    suggestion_id: str
    decision: DecisionType
    custom_correction: Optional[str] = None
    reason: Optional[str] = None
    tags: Optional[List[str]] = None

@dataclass
class DateRange:
    """日期範圍"""
    start_date: datetime
    end_date: datetime
```

### 4.2 輸出模型

```python
@dataclass
class DecisionPatterns:
    """決策模式"""
    common_acceptances: List[PatternDetail]
    common_rejections: List[PatternDetail]
    custom_corrections: List[CorrectionPattern]
    time_patterns: List[TimePattern]
    confidence_scores: Dict[str, float]

@dataclass
class UserPreferences:
    """用戶偏好"""
    style_preferences: Dict[str, Any]
    vocabulary_preferences: List[str]
    grammar_rules: List[str]
    punctuation_habits: Dict[str, str]

@dataclass
class LearningRule:
    """學習規則"""
    rule_id: str
    rule_type: str  # "replacement", "style", "grammar"
    pattern: str
    replacement: Optional[str]
    context_conditions: Dict[str, Any]
    confidence: float
    example_applications: List[str]
```

## 5. 業務邏輯實現

### 5.1 決策記錄流程

```python
async def record_decision(self, ...):
    """記錄決策的完整流程"""

    # 1. 驗證輸入
    await self._validate_decision_input(...)

    # 2. 檢查重複
    existing = await self._check_existing_decision(...)
    if existing:
        return await self._update_decision(existing, ...)

    # 3. 創建決策記錄
    decision = ProofreadingDecision(...)

    # 4. 計算決策權重（基於用戶歷史準確率）
    decision.confidence_score = await self._calculate_confidence(...)

    # 5. 保存到數據庫
    session.add(decision)
    await session.commit()

    # 6. 觸發異步學習（如果達到閾值）
    if await self._should_trigger_learning(session):
        await self._trigger_async_learning(article_id)

    return decision
```

### 5.2 模式識別算法

```python
async def analyze_decision_patterns(self, ...):
    """模式識別的核心算法"""

    # 1. 收集決策數據
    decisions = await self._collect_decisions(session, time_range)

    # 2. 按建議類型分組
    grouped = self._group_by_suggestion_type(decisions)

    # 3. 計算統計指標
    statistics = {}
    for suggestion_type, group_decisions in grouped.items():
        statistics[suggestion_type] = {
            'total': len(group_decisions),
            'accepted': sum(1 for d in group_decisions if d.decision == 'accept'),
            'rejected': sum(1 for d in group_decisions if d.decision == 'reject'),
            'modified': sum(1 for d in group_decisions if d.decision == 'modify'),
            'acceptance_rate': accepted / total if total > 0 else 0
        }

    # 4. 識別顯著模式
    patterns = self._identify_significant_patterns(
        statistics,
        min_occurrences=min_occurrences,
        significance_level=0.95
    )

    # 5. 提取自定義修正模式
    custom_patterns = await self._extract_custom_patterns(
        [d for d in decisions if d.custom_correction]
    )

    return DecisionPatterns(
        common_acceptances=patterns['high_acceptance'],
        common_rejections=patterns['high_rejection'],
        custom_corrections=custom_patterns,
        time_patterns=self._analyze_time_patterns(decisions)
    )
```

### 5.3 規則生成邏輯

```python
async def generate_learning_rules(self, ...):
    """從模式生成可執行規則"""

    rules = []

    # 1. 生成替換規則
    for pattern in patterns.custom_corrections:
        if pattern.frequency >= self.min_pattern_threshold:
            rule = LearningRule(
                rule_id=f"replace_{pattern.id}",
                rule_type="replacement",
                pattern=pattern.original_pattern,
                replacement=pattern.correction_pattern,
                confidence=pattern.confidence,
                context_conditions=pattern.context
            )
            rules.append(rule)

    # 2. 生成風格規則
    for acceptance in patterns.common_acceptances:
        if acceptance.rate >= confidence_threshold:
            rule = self._create_style_rule(acceptance)
            rules.append(rule)

    # 3. 生成否定規則（不應該做的修改）
    for rejection in patterns.common_rejections:
        if rejection.rate >= confidence_threshold:
            rule = self._create_negative_rule(rejection)
            rules.append(rule)

    # 4. 驗證規則一致性
    rules = self._validate_rule_consistency(rules)

    return rules
```

## 6. 性能優化策略

### 6.1 緩存策略
```python
# 使用 Redis 緩存熱點數據
@lru_cache(maxsize=100)
async def get_cached_patterns(cache_key: str):
    """緩存決策模式"""
    pass

# 使用數據庫索引優化查詢
# 索引：(article_id, created_at)
# 索引：(suggestion_type, decision)
```

### 6.2 批處理優化
```python
# 批量處理決策以減少數據庫往返
async def record_batch_decisions(self, decisions: List[DecisionInput]):
    async with session.begin():
        # 使用 bulk_insert_mappings 提高性能
        session.bulk_insert_mappings(ProofreadingDecision, decisions)
```

### 6.3 異步處理
```python
# 使用 Celery 異步處理耗時的學習任務
@celery_task
async def async_pattern_learning(article_id: int):
    """異步執行模式學習"""
    pass
```

## 7. 錯誤處理

```python
class DecisionServiceError(Exception):
    """決策服務基礎異常"""
    pass

class DuplicateDecisionError(DecisionServiceError):
    """重複決策異常"""
    pass

class InvalidDecisionError(DecisionServiceError):
    """無效決策異常"""
    pass

class PatternAnalysisError(DecisionServiceError):
    """模式分析異常"""
    pass
```

## 8. 測試策略

### 8.1 單元測試覆蓋
- 決策記錄邏輯
- 模式識別算法
- 規則生成邏輯
- 錯誤處理

### 8.2 集成測試
- 數據庫事務
- 批量操作
- 並發處理
- 性能測試

### 8.3 測試數據準備
```python
# tests/fixtures/decision_fixtures.py
def create_test_decisions(count: int = 100):
    """創建測試決策數據"""
    pass

def create_test_patterns():
    """創建測試模式數據"""
    pass
```

## 9. 監控指標

### 9.1 業務指標
- 每日決策數量
- 決策響應時間
- 模式識別準確率
- 規則應用成功率

### 9.2 技術指標
- API 響應時間
- 數據庫查詢性能
- 緩存命中率
- 錯誤率

## 10. 部署考量

### 10.1 環境變量
```bash
# 決策服務配置
DECISION_MIN_PATTERN_THRESHOLD=5
DECISION_CONFIDENCE_THRESHOLD=0.8
DECISION_CACHE_TTL=3600
DECISION_BATCH_SIZE=100
```

### 10.2 資源需求
- CPU: 中等（模式分析時較高）
- 內存: 2-4GB（緩存需求）
- 存儲: 取決於決策數據量
- 網絡: 低延遲數據庫連接

## 11. 未來優化方向

1. **機器學習集成**: 使用 ML 模型自動識別複雜模式
2. **實時學習**: 實時更新規則，無需批處理
3. **多用戶協同**: 跨用戶共享通用規則
4. **A/B 測試**: 測試不同規則的效果
5. **可解釋性**: 提供決策和規則的解釋