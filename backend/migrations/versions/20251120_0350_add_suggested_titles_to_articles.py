"""add_suggested_titles_to_articles

Revision ID: e498bbc20225
Revises: 9b8622d858cf
Create Date: 2025-11-20 03:50:33.329104+00:00

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'e498bbc20225'
down_revision: Union[str, None] = '9b8622d858cf'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('execution_logs_2025_10_created_at_idx'), table_name='execution_logs_2025_10')
    op.drop_index(op.f('execution_logs_2025_10_log_level_idx'), table_name='execution_logs_2025_10')
    op.drop_index(op.f('execution_logs_2025_10_task_id_idx'), table_name='execution_logs_2025_10')
    op.drop_table('execution_logs_2025_10')
    op.drop_index(op.f('execution_logs_2025_11_created_at_idx'), table_name='execution_logs_2025_11')
    op.drop_index(op.f('execution_logs_2025_11_log_level_idx'), table_name='execution_logs_2025_11')
    op.drop_index(op.f('execution_logs_2025_11_task_id_idx'), table_name='execution_logs_2025_11')
    op.drop_table('execution_logs_2025_11')
    op.alter_column('app_settings', 'provider_config',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Publishing provider configuration (playwright/computer_use/hybrid)',
               existing_nullable=False)
    op.alter_column('app_settings', 'cms_config',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='CMS connection details and preferences',
               existing_nullable=False)
    op.alter_column('app_settings', 'cost_limits',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Cost thresholds and budgeting rules',
               existing_nullable=False)
    op.alter_column('app_settings', 'screenshot_retention',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Screenshot retention policies (count, duration)',
               existing_nullable=False)
    op.alter_column('app_settings', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               server_default=None,
               type_=sa.DateTime(),
               existing_comment='Last update timestamp',
               existing_nullable=False)
    op.alter_column('article_faqs', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Article this FAQ belongs to (one-to-many relationship)',
               existing_comment='Reference to article for which FAQ was generated',
               existing_nullable=False)
    op.alter_column('article_faqs', 'question_type',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Enum('FACTUAL', 'HOW_TO', 'COMPARISON', 'DEFINITION', name='faq_question_type'),
               existing_comment='Type: factual, how_to, comparison, definition',
               existing_nullable=True)
    op.alter_column('article_faqs', 'search_intent',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Enum('INFORMATIONAL', 'NAVIGATIONAL', 'TRANSACTIONAL', name='faq_search_intent'),
               existing_comment='Intent: informational, navigational, transactional',
               existing_nullable=True)
    op.alter_column('article_faqs', 'status',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Enum('DRAFT', 'APPROVED', 'REJECTED', 'PUBLISHED', name='faq_status'),
               existing_comment='Status: draft, approved, rejected, published',
               existing_nullable=False,
               existing_server_default=sa.text("'draft'::character varying"))
    op.drop_index(op.f('idx_article_faqs_article_id'), table_name='article_faqs')
    op.drop_index(op.f('idx_article_faqs_position'), table_name='article_faqs')
    op.drop_index(op.f('idx_article_faqs_status'), table_name='article_faqs')
    op.create_index(op.f('ix_article_faqs_article_id'), 'article_faqs', ['article_id'], unique=False)
    op.create_index(op.f('ix_article_faqs_status'), 'article_faqs', ['status'], unique=False)
    op.alter_column('article_image_reviews', 'action',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Enum('keep', 'remove', 'replace_caption', 'replace_source', name='imagereviewaction'),
               existing_comment='Action taken: keep|remove|replace_caption|replace_source',
               existing_nullable=False)
    op.alter_column('article_image_reviews', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='Timestamp when review was created',
               existing_nullable=False)
    op.drop_index(op.f('idx_article_image_reviews_action'), table_name='article_image_reviews')
    op.drop_index(op.f('idx_article_image_reviews_article_image'), table_name='article_image_reviews')
    op.drop_index(op.f('idx_article_image_reviews_created_at'), table_name='article_image_reviews')
    op.drop_index(op.f('idx_article_image_reviews_worklist_item'), table_name='article_image_reviews')
    op.create_index(op.f('ix_article_image_reviews_action'), 'article_image_reviews', ['action'], unique=False)
    op.create_index(op.f('ix_article_image_reviews_article_image_id'), 'article_image_reviews', ['article_image_id'], unique=False)
    op.create_index(op.f('ix_article_image_reviews_created_at'), 'article_image_reviews', ['created_at'], unique=False)
    op.create_index(op.f('ix_article_image_reviews_worklist_item_id'), 'article_image_reviews', ['worklist_item_id'], unique=False)
    op.drop_table_comment(
        'article_image_reviews',
        existing_comment='Tracks reviewer feedback and actions on individual images during parsing confirmation',
        schema=None
    )
    op.alter_column('article_images', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('article_images', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_article_images_article_id'), table_name='article_images')
    op.drop_index(op.f('idx_article_images_created_at'), table_name='article_images')
    op.drop_index(op.f('idx_article_images_metadata_gin'), table_name='article_images', postgresql_using='gin')
    op.drop_index(op.f('idx_article_images_position'), table_name='article_images')
    op.create_index(op.f('ix_article_images_article_id'), 'article_images', ['article_id'], unique=False)
    op.drop_table_comment(
        'article_images',
        existing_comment='Stores structured information about images extracted from articles',
        schema=None
    )
    op.alter_column('article_status_history', 'old_status',
               existing_type=sa.VARCHAR(length=50),
               comment='Previous article status value',
               existing_nullable=True)
    op.alter_column('article_status_history', 'new_status',
               existing_type=sa.VARCHAR(length=50),
               comment='New article status value',
               existing_nullable=False)
    op.alter_column('article_status_history', 'changed_by',
               existing_type=sa.VARCHAR(length=100),
               comment="User id or 'system' for automated transitions",
               existing_nullable=True)
    op.alter_column('article_status_history', 'change_reason',
               existing_type=sa.VARCHAR(length=255),
               comment='Optional description of why the transition occurred',
               existing_nullable=True)
    op.alter_column('article_status_history', 'metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               comment='Structured metadata describing the transition context',
               existing_nullable=False)
    op.alter_column('article_status_history', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='Timestamp when the status change occurred',
               existing_nullable=False)
    op.add_column('articles', sa.Column('suggested_titles', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='AI-suggested title variations (2-3 options with scores)'))
    op.alter_column('articles', 'body',
               existing_type=sa.TEXT(),
               comment='Full article content (Markdown or HTML)',
               existing_comment='Full article content',
               existing_nullable=False)
    op.alter_column('articles', 'status',
               existing_type=postgresql.ENUM('draft', 'in-review', 'scheduled', 'published', 'failed', 'imported', 'seo_optimized', 'ready_to_publish', 'publishing', name='articlestatus'),
               server_default=None,
               existing_comment='Workflow status',
               existing_nullable=False)
    op.alter_column('articles', 'source',
               existing_type=sa.VARCHAR(length=50),
               server_default=None,
               existing_comment='Article import source (csv_import, json_import, manual, wordpress_export)',
               existing_nullable=False)
    op.alter_column('articles', 'additional_images',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Array of additional image paths',
               existing_nullable=True)
    op.alter_column('articles', 'proofreading_issues',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               comment='Combined AI/script proofreading issues',
               existing_nullable=False)
    op.alter_column('articles', 'critical_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='Count of blocking (F-class) issues',
               existing_nullable=False)
    op.alter_column('articles', 'suggested_seo_keywords',
               existing_type=postgresql.ARRAY(sa.VARCHAR()),
               comment='AI-suggested SEO keywords array',
               existing_nullable=True)
    op.alter_column('articles', 'seo_keywords',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_comment='Array of SEO keywords extracted from content',
               existing_nullable=True)
    op.alter_column('articles', 'published_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_comment='Actual publication timestamp',
               existing_nullable=True)
    op.alter_column('articles', 'unified_optimization_generated',
               existing_type=sa.BOOLEAN(),
               server_default=None,
               comment='Whether unified AI optimizations have been generated',
               existing_comment='Whether unified optimization (title+SEO+FAQ) has been generated',
               existing_nullable=False)
    op.alter_column('articles', 'unified_optimization_cost',
               existing_type=sa.NUMERIC(precision=10, scale=4),
               type_=sa.Numeric(precision=10, scale=6),
               existing_comment='Cost in USD for generating all optimizations',
               existing_nullable=True)
    op.alter_column('articles', 'article_metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               comment='CMS-specific metadata (featured image, excerpt, etc.)',
               existing_comment='CMS-specific metadata',
               existing_nullable=False)
    op.alter_column('articles', 'formatting',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               comment='Formatting preferences (headings, lists, code blocks)',
               existing_comment='Formatting preferences',
               existing_nullable=False)
    op.alter_column('articles', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('articles', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_articles_author'), table_name='articles')
    op.drop_index(op.f('idx_articles_metadata'), table_name='articles', postgresql_using='gin')
    op.drop_index(op.f('idx_articles_parsing_confirmed'), table_name='articles', postgresql_where='(parsing_confirmed = false)')
    op.drop_index(op.f('idx_articles_parsing_confirmed_at'), table_name='articles')
    op.drop_index(op.f('idx_articles_published'), table_name='articles', postgresql_where='(published_at IS NOT NULL)')
    op.drop_index(op.f('idx_articles_published_url'), table_name='articles')
    op.drop_index(op.f('idx_articles_source'), table_name='articles')
    op.drop_index(op.f('idx_articles_status'), table_name='articles')
    op.drop_index(op.f('idx_articles_unified_optimization_generated'), table_name='articles', postgresql_where='(unified_optimization_generated = false)')
    op.create_index(op.f('ix_articles_author_id'), 'articles', ['author_id'], unique=False)
    op.create_index(op.f('ix_articles_published_at'), 'articles', ['published_at'], unique=False)
    op.create_index(op.f('ix_articles_published_url'), 'articles', ['published_url'], unique=False)
    op.create_index(op.f('ix_articles_source'), 'articles', ['source'], unique=False)
    op.create_index(op.f('ix_articles_status'), 'articles', ['status'], unique=False)
    op.create_index(op.f('ix_articles_unified_optimization_generated'), 'articles', ['unified_optimization_generated'], unique=False)
    op.alter_column('execution_logs', 'task_id',
               existing_type=sa.INTEGER(),
               comment='Reference to publish task',
               existing_nullable=False)
    op.alter_column('execution_logs', 'log_level',
               existing_type=postgresql.ENUM('DEBUG', 'INFO', 'WARNING', 'ERROR', name='log_level_enum'),
               server_default=None,
               type_=sa.Enum('DEBUG', 'INFO', 'WARNING', 'ERROR', name='loglevel'),
               comment='Log severity level',
               existing_nullable=False)
    op.alter_column('execution_logs', 'step_name',
               existing_type=sa.VARCHAR(length=100),
               comment='Publishing step name',
               existing_nullable=True)
    op.alter_column('execution_logs', 'message',
               existing_type=sa.TEXT(),
               comment='Log message',
               existing_nullable=True)
    op.alter_column('execution_logs', 'details',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               comment='Additional structured log data',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_type',
               existing_type=sa.VARCHAR(length=50),
               comment='Action type (navigate, click, type, upload, screenshot)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_target',
               existing_type=sa.VARCHAR(length=200),
               comment='Target element (CSS selector, URL, etc.)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_result',
               existing_type=sa.VARCHAR(length=50),
               comment='Action result (success, failed, timeout)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'screenshot_url',
               existing_type=sa.VARCHAR(length=500),
               comment='Associated screenshot URL',
               existing_nullable=True)
    op.alter_column('execution_logs', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               server_default=None,
               type_=sa.DateTime(),
               comment='When log entry was created (partition key)',
               existing_nullable=False)
    op.drop_index(op.f('idx_execution_logs_created_at'), table_name='execution_logs')
    op.drop_index(op.f('idx_execution_logs_log_level'), table_name='execution_logs')
    op.drop_index(op.f('idx_execution_logs_task_id'), table_name='execution_logs')
    op.create_index(op.f('ix_execution_logs_created_at'), 'execution_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_execution_logs_log_level'), 'execution_logs', ['log_level'], unique=False)
    op.create_index(op.f('ix_execution_logs_task_id'), 'execution_logs', ['task_id'], unique=False)
    op.alter_column('feedback_tuning_jobs', 'job_type',
               existing_type=sa.VARCHAR(length=30),
               type_=sa.Enum('rule_tuning', 'prompt_optimization', 'batch_analysis', name='tuningjobtype'),
               comment='任务类型',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'job_name',
               existing_type=sa.VARCHAR(length=200),
               comment='任务名称',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'job_description',
               existing_type=sa.TEXT(),
               comment='任务描述',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'target_rule_ids',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               comment='目标规则ID列表',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'target_categories',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               comment='目标规则类别列表',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'start_date',
               existing_type=sa.DATE(),
               comment='开始日期',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'end_date',
               existing_type=sa.DATE(),
               comment='结束日期',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'total_decisions_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='总决策数量',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'processed_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='已处理数量',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'status',
               existing_type=sa.VARCHAR(length=20),
               server_default=None,
               type_=sa.Enum('pending', 'running', 'completed', 'failed', name='tuningjobstatus'),
               comment='任务状态',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'progress_percent',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='进度百分比',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'results',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='分析结果',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'recommendations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='优化建议',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'error_message',
               existing_type=sa.TEXT(),
               comment='错误消息',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'error_details',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='错误详情',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'created_by',
               existing_type=sa.INTEGER(),
               comment='创建者用户ID',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='创建时间',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'started_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='开始时间',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'completed_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='完成时间',
               existing_nullable=True)
    op.drop_index(op.f('idx_feedback_tuning_jobs_created_at'), table_name='feedback_tuning_jobs')
    op.drop_index(op.f('idx_feedback_tuning_jobs_status'), table_name='feedback_tuning_jobs')
    op.drop_index(op.f('idx_feedback_tuning_jobs_type_status'), table_name='feedback_tuning_jobs')
    op.create_index(op.f('ix_feedback_tuning_jobs_created_at'), 'feedback_tuning_jobs', ['created_at'], unique=False)
    op.create_index(op.f('ix_feedback_tuning_jobs_status'), 'feedback_tuning_jobs', ['status'], unique=False)
    op.drop_table_comment(
        'feedback_tuning_jobs',
        existing_comment='反馈调优任务表，用于批量分析用户反馈并生成规则优化建议',
        schema=None
    )
    op.alter_column('proofreading_decisions', 'article_id',
               existing_type=sa.INTEGER(),
               comment='关联的文章ID',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'suggestion_id',
               existing_type=sa.VARCHAR(length=100),
               comment='建议的唯一标识符',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'proofreading_history_id',
               existing_type=sa.INTEGER(),
               comment='关联的校对历史ID',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'decision_type',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Enum('accepted', 'rejected', 'modified', name='decisiontype'),
               comment='决策类型',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'decision_rationale',
               existing_type=sa.TEXT(),
               comment='决策理由',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'modified_content',
               existing_type=sa.TEXT(),
               comment='修改后的内容',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'original_text',
               existing_type=sa.TEXT(),
               comment='原始文本',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'suggested_text',
               existing_type=sa.TEXT(),
               comment='建议文本',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'rule_id',
               existing_type=sa.VARCHAR(length=20),
               comment='触发的规则ID',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'rule_category',
               existing_type=sa.VARCHAR(length=10),
               comment='规则类别',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'issue_position',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='问题位置信息',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'feedback_provided',
               existing_type=sa.BOOLEAN(),
               server_default=None,
               comment='是否提供了反馈',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'feedback_category',
               existing_type=sa.VARCHAR(length=50),
               comment='反馈类别',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'feedback_notes',
               existing_type=sa.TEXT(),
               comment='反馈备注',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'feedback_status',
               existing_type=sa.VARCHAR(length=20),
               server_default=None,
               type_=sa.Enum('pending', 'in_progress', 'completed', 'failed', name='feedbackstatus'),
               comment='反馈状态',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'decided_by',
               existing_type=sa.INTEGER(),
               comment='决策者用户ID',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'decided_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='决策时间',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('proofreading_decisions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.drop_index(op.f('idx_proofreading_decisions_article_id'), table_name='proofreading_decisions')
    op.drop_index(op.f('idx_proofreading_decisions_decided_at'), table_name='proofreading_decisions')
    op.drop_index(op.f('idx_proofreading_decisions_decision_type'), table_name='proofreading_decisions')
    op.drop_index(op.f('idx_proofreading_decisions_feedback_status'), table_name='proofreading_decisions', postgresql_where='(feedback_provided = true)')
    op.drop_index(op.f('idx_proofreading_decisions_rule_id'), table_name='proofreading_decisions')
    op.drop_index(op.f('idx_proofreading_decisions_stats'), table_name='proofreading_decisions')
    op.drop_constraint(op.f('uq_article_suggestion'), 'proofreading_decisions', type_='unique')
    op.create_index(op.f('ix_proofreading_decisions_article_id'), 'proofreading_decisions', ['article_id'], unique=False)
    op.create_index(op.f('ix_proofreading_decisions_decided_at'), 'proofreading_decisions', ['decided_at'], unique=False)
    op.create_index(op.f('ix_proofreading_decisions_decision_type'), 'proofreading_decisions', ['decision_type'], unique=False)
    op.create_index(op.f('ix_proofreading_decisions_feedback_status'), 'proofreading_decisions', ['feedback_status'], unique=False)
    op.create_index(op.f('ix_proofreading_decisions_rule_id'), 'proofreading_decisions', ['rule_id'], unique=False)
    op.drop_table_comment(
        'proofreading_decisions',
        existing_comment='校对决策记录表，存储用户对校对建议的接受、拒绝或修改决策',
        schema=None
    )
    op.alter_column('proofreading_history', 'article_id',
               existing_type=sa.INTEGER(),
               comment='关联的文章ID',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'executed_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='执行时间',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'execution_duration_ms',
               existing_type=sa.INTEGER(),
               comment='执行耗时（毫秒）',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'engine_version',
               existing_type=sa.VARCHAR(length=20),
               comment='引擎版本号',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'total_issues_found',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='发现的问题总数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'critical_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='严重问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'warning_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='警告问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'info_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='提示问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'accepted_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='接受的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'rejected_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='拒绝的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'modified_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='修改的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'pending_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='待处理的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'feedback_provided_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='提供反馈的数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'pending_feedback_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='待处理反馈的数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'deterministic_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='确定性引擎发现的问题数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'ai_issues_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               comment='AI引擎发现的问题数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'issues_snapshot',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='校对问题的完整快照',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'config_snapshot',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='校对配置快照',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'executed_by',
               existing_type=sa.INTEGER(),
               comment='执行者用户ID',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=None,
               comment='创建时间',
               existing_nullable=False)
    op.drop_index(op.f('idx_proofreading_history_article_id'), table_name='proofreading_history')
    op.drop_index(op.f('idx_proofreading_history_executed_at'), table_name='proofreading_history')
    op.drop_index(op.f('idx_proofreading_history_pending_feedback'), table_name='proofreading_history', postgresql_where='(pending_feedback_count > 0)')
    op.create_index(op.f('ix_proofreading_history_article_id'), 'proofreading_history', ['article_id'], unique=False)
    op.create_index(op.f('ix_proofreading_history_executed_at'), 'proofreading_history', ['executed_at'], unique=False)
    op.drop_table_comment(
        'proofreading_history',
        existing_comment='校对执行历史记录表，存储每次校对的执行结果和统计信息',
        schema=None
    )
    op.alter_column('provider_metrics', 'provider',
               existing_type=postgresql.ENUM('playwright', 'computer_use', 'hybrid', name='provider_enum'),
               type_=sa.Enum('PLAYWRIGHT', 'COMPUTER_USE', 'HYBRID', name='provider'),
               existing_nullable=False)
    op.alter_column('provider_metrics', 'total_tasks',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Total tasks executed during interval',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'successful_tasks',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Total successful tasks',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'failed_tasks',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Total failed tasks',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'success_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               server_default=None,
               existing_comment='Success rate percentage (0-100)',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               server_default=None,
               type_=sa.DateTime(),
               existing_comment='Record creation timestamp',
               existing_nullable=False)
    op.drop_constraint(op.f('uq_provider_metrics_provider_date'), 'provider_metrics', type_='unique')
    op.alter_column('publish_tasks', 'provider',
               existing_type=postgresql.ENUM('playwright', 'computer_use', 'hybrid', name='provider_enum'),
               server_default=None,
               type_=sa.Enum('playwright', 'computer_use', 'hybrid', name='provider'),
               existing_comment='Computer Use provider (anthropic, gemini, playwright)',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'cms_type',
               existing_type=sa.VARCHAR(length=50),
               server_default=None,
               existing_comment='Target CMS type (wordpress, drupal, etc.)',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'status',
               existing_type=postgresql.ENUM('idle', 'pending', 'initializing', 'logging_in', 'creating_post', 'uploading_images', 'configuring_seo', 'publishing', 'completed', 'failed', name='task_status_enum'),
               server_default=None,
               type_=sa.Enum('idle', 'pending', 'initializing', 'logging_in', 'creating_post', 'uploading_images', 'configuring_seo', 'publishing', 'completed', 'failed', name='taskstatus'),
               existing_comment='Task execution status',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'progress',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Task progress percentage (0-100)',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'current_step',
               existing_type=sa.VARCHAR(length=100),
               server_default=None,
               existing_comment='Current step description',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'total_steps',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Total number of steps in publishing workflow',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'completed_steps',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Number of completed steps',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'retry_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Number of retry attempts',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'max_retries',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Maximum retry attempts allowed',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'screenshots',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Array of screenshot metadata {url, step, timestamp}',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'started_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_comment='When task execution started',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'completed_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_comment='When task completed (success or failure)',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               server_default=None,
               type_=sa.DateTime(),
               existing_comment='When task was created',
               existing_nullable=False)
    op.drop_index(op.f('idx_publish_tasks_article_id'), table_name='publish_tasks')
    op.drop_index(op.f('idx_publish_tasks_created_at'), table_name='publish_tasks')
    op.drop_index(op.f('idx_publish_tasks_provider'), table_name='publish_tasks')
    op.drop_index(op.f('idx_publish_tasks_status'), table_name='publish_tasks')
    op.drop_index(op.f('idx_publish_tasks_task_id'), table_name='publish_tasks')
    op.drop_constraint(op.f('publish_tasks_task_id_key'), 'publish_tasks', type_='unique')
    op.create_index(op.f('ix_publish_tasks_article_id'), 'publish_tasks', ['article_id'], unique=False)
    op.create_index(op.f('ix_publish_tasks_created_at'), 'publish_tasks', ['created_at'], unique=False)
    op.create_index(op.f('ix_publish_tasks_provider'), 'publish_tasks', ['provider'], unique=False)
    op.create_index(op.f('ix_publish_tasks_status'), 'publish_tasks', ['status'], unique=False)
    op.create_index(op.f('ix_publish_tasks_task_id'), 'publish_tasks', ['task_id'], unique=True)
    op.alter_column('seo_metadata', 'keyword_density',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Keyword -> {count, density} mapping',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'optimization_recommendations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Array of optimization suggestions',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'manual_overrides',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='User-edited fields tracking',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'generated_by',
               existing_type=sa.VARCHAR(length=50),
               server_default=None,
               existing_comment='AI model used for generation',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record creation timestamp',
               existing_comment='When SEO analysis was created',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('seo_metadata', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record last update timestamp',
               existing_comment='When SEO metadata was last updated',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_seo_metadata_article_id'), table_name='seo_metadata')
    op.drop_index(op.f('idx_seo_metadata_focus_keyword'), table_name='seo_metadata')
    op.drop_index(op.f('idx_seo_metadata_seo_score'), table_name='seo_metadata')
    op.drop_constraint(op.f('seo_metadata_article_id_key'), 'seo_metadata', type_='unique')
    op.create_index(op.f('ix_seo_metadata_article_id'), 'seo_metadata', ['article_id'], unique=True)
    op.create_index(op.f('ix_seo_metadata_focus_keyword'), 'seo_metadata', ['focus_keyword'], unique=False)
    op.create_index(op.f('ix_seo_metadata_seo_score'), 'seo_metadata', ['seo_score'], unique=False)
    op.alter_column('seo_suggestions', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Article for which SEO suggestions were generated (one-to-one relationship)',
               existing_comment='Reference to article for which SEO suggestions were generated',
               existing_nullable=False)
    op.alter_column('seo_suggestions', 'keyword_difficulty',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Difficulty scores for keywords (0.0-1.0)',
               existing_comment='Difficulty scores for keywords',
               existing_nullable=True)
    op.alter_column('seo_suggestions', 'suggested_meta_description',
               existing_type=sa.TEXT(),
               comment='AI-optimized meta description (150-160 chars recommended)',
               existing_comment='AI-optimized meta description (150-160 chars)',
               existing_nullable=True)
    op.alter_column('seo_suggestions', 'suggested_tags',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Array of suggested tags with relevance scores and types',
               existing_comment='Array of suggested tags with relevance scores',
               existing_nullable=True)
    op.drop_index(op.f('idx_seo_suggestions_article_id'), table_name='seo_suggestions')
    op.drop_index(op.f('idx_seo_suggestions_focus_keyword'), table_name='seo_suggestions')
    op.drop_constraint(op.f('uq_seo_suggestions_article_id'), 'seo_suggestions', type_='unique')
    op.create_index(op.f('ix_seo_suggestions_article_id'), 'seo_suggestions', ['article_id'], unique=True)
    op.create_index(op.f('ix_seo_suggestions_focus_keyword'), 'seo_suggestions', ['focus_keyword'], unique=False)
    op.alter_column('title_suggestions', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Article for which suggestions were generated (one-to-one relationship)',
               existing_comment='Reference to article for which suggestions were generated',
               existing_nullable=False)
    op.drop_index(op.f('idx_title_suggestions_article_id'), table_name='title_suggestions')
    op.drop_index(op.f('idx_title_suggestions_generated_at'), table_name='title_suggestions')
    op.drop_constraint(op.f('uq_title_suggestions_article_id'), 'title_suggestions', type_='unique')
    op.create_index(op.f('ix_title_suggestions_article_id'), 'title_suggestions', ['article_id'], unique=True)
    op.alter_column('topic_embeddings', 'topic_text',
               existing_type=sa.TEXT(),
               comment='Original topic description used for embedding',
               existing_comment='Original topic description',
               existing_nullable=False)
    op.alter_column('topic_embeddings', 'embedding',
               existing_type=postgresql.ARRAY(sa.DOUBLE_PRECISION(precision=53)),
               comment='Vector embedding for semantic similarity',
               existing_comment='Vector embedding',
               existing_nullable=False)
    op.alter_column('topic_embeddings', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_embeddings', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_topic_embeddings_article'), table_name='topic_embeddings')
    op.drop_constraint(op.f('topic_embeddings_article_id_key'), 'topic_embeddings', type_='unique')
    op.create_index(op.f('ix_topic_embeddings_article_id'), 'topic_embeddings', ['article_id'], unique=True)
    op.add_column('topic_requests', sa.Column('title', sa.String(length=500), nullable=False, comment='Topic title'))
    op.alter_column('topic_requests', 'outline',
               existing_type=sa.TEXT(),
               comment='Optional structured outline (JSON or Markdown)',
               existing_comment='Optional structured outline',
               existing_nullable=True)
    op.alter_column('topic_requests', 'style_tone',
               existing_type=sa.VARCHAR(length=50),
               server_default=None,
               existing_comment='Requested writing style',
               existing_nullable=False)
    op.alter_column('topic_requests', 'target_word_count',
               existing_type=sa.INTEGER(),
               server_default=None,
               existing_comment='Desired article length',
               existing_nullable=False)
    op.alter_column('topic_requests', 'priority',
               existing_type=postgresql.ENUM('urgent', 'normal', 'low', name='topicrequestpriority'),
               server_default=None,
               existing_comment='Processing priority',
               existing_nullable=False)
    op.alter_column('topic_requests', 'status',
               existing_type=postgresql.ENUM('pending', 'processing', 'completed', 'failed', 'cancelled', name='topicrequeststatus'),
               server_default=None,
               existing_comment='Request processing status',
               existing_nullable=False)
    op.alter_column('topic_requests', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_requests', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('idx_topic_requests_priority'), table_name='topic_requests')
    op.drop_index(op.f('idx_topic_requests_status'), table_name='topic_requests')
    op.drop_index(op.f('idx_topic_requests_submitted'), table_name='topic_requests')
    op.create_index(op.f('ix_topic_requests_status'), 'topic_requests', ['status'], unique=False)
    op.drop_column('topic_requests', 'topic_description')
    op.alter_column('worklist_items', 'status',
               existing_type=postgresql.ENUM('pending', 'proofreading', 'under_review', 'ready_to_publish', 'publishing', 'published', 'failed', 'parsing', 'parsing_review', 'proofreading_review', name='workliststatus'),
               server_default=None,
               existing_comment='Worklist processing status',
               existing_nullable=False)
    op.alter_column('worklist_items', 'raw_html',
               existing_type=sa.TEXT(),
               comment='Original HTML from Google Docs export (for parser with images)',
               existing_nullable=True)
    op.alter_column('worklist_items', 'metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Drive metadata (links, owners, custom fields)',
               existing_nullable=False)
    op.alter_column('worklist_items', 'notes',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=None,
               existing_comment='Reviewer notes and history',
               existing_nullable=False)
    op.alter_column('worklist_items', 'synced_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               server_default=None,
               type_=sa.DateTime(),
               existing_comment='Last time the record was synced from Drive',
               existing_nullable=False)
    op.drop_index(op.f('ix_worklist_items_updated_at'), table_name='worklist_items')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_index(op.f('ix_worklist_items_updated_at'), 'worklist_items', ['updated_at'], unique=False)
    op.alter_column('worklist_items', 'synced_at',
               existing_type=sa.DateTime(),
               server_default=sa.text('now()'),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='Last time the record was synced from Drive',
               existing_nullable=False)
    op.alter_column('worklist_items', 'notes',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'[]'::jsonb"),
               existing_comment='Reviewer notes and history',
               existing_nullable=False)
    op.alter_column('worklist_items', 'metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='Drive metadata (links, owners, custom fields)',
               existing_nullable=False)
    op.alter_column('worklist_items', 'raw_html',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Original HTML from Google Docs export (for parser with images)',
               existing_nullable=True)
    op.alter_column('worklist_items', 'status',
               existing_type=postgresql.ENUM('pending', 'proofreading', 'under_review', 'ready_to_publish', 'publishing', 'published', 'failed', 'parsing', 'parsing_review', 'proofreading_review', name='workliststatus'),
               server_default=sa.text("'pending'::workliststatus"),
               existing_comment='Worklist processing status',
               existing_nullable=False)
    op.add_column('topic_requests', sa.Column('topic_description', sa.TEXT(), autoincrement=False, nullable=False, comment='User-provided topic or outline'))
    op.drop_index(op.f('ix_topic_requests_status'), table_name='topic_requests')
    op.create_index(op.f('idx_topic_requests_submitted'), 'topic_requests', ['created_at'], unique=False)
    op.create_index(op.f('idx_topic_requests_status'), 'topic_requests', ['status'], unique=False)
    op.create_index(op.f('idx_topic_requests_priority'), 'topic_requests', ['priority', 'created_at'], unique=False)
    op.alter_column('topic_requests', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_requests', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_requests', 'status',
               existing_type=postgresql.ENUM('pending', 'processing', 'completed', 'failed', 'cancelled', name='topicrequeststatus'),
               server_default=sa.text("'pending'::topicrequeststatus"),
               existing_comment='Request processing status',
               existing_nullable=False)
    op.alter_column('topic_requests', 'priority',
               existing_type=postgresql.ENUM('urgent', 'normal', 'low', name='topicrequestpriority'),
               server_default=sa.text("'normal'::topicrequestpriority"),
               existing_comment='Processing priority',
               existing_nullable=False)
    op.alter_column('topic_requests', 'target_word_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('1000'),
               existing_comment='Desired article length',
               existing_nullable=False)
    op.alter_column('topic_requests', 'style_tone',
               existing_type=sa.VARCHAR(length=50),
               server_default=sa.text("'professional'::character varying"),
               existing_comment='Requested writing style',
               existing_nullable=False)
    op.alter_column('topic_requests', 'outline',
               existing_type=sa.TEXT(),
               comment='Optional structured outline',
               existing_comment='Optional structured outline (JSON or Markdown)',
               existing_nullable=True)
    op.drop_column('topic_requests', 'title')
    op.drop_index(op.f('ix_topic_embeddings_article_id'), table_name='topic_embeddings')
    op.create_unique_constraint(op.f('topic_embeddings_article_id_key'), 'topic_embeddings', ['article_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_topic_embeddings_article'), 'topic_embeddings', ['article_id'], unique=False)
    op.alter_column('topic_embeddings', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_embeddings', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('topic_embeddings', 'embedding',
               existing_type=postgresql.ARRAY(sa.DOUBLE_PRECISION(precision=53)),
               comment='Vector embedding',
               existing_comment='Vector embedding for semantic similarity',
               existing_nullable=False)
    op.alter_column('topic_embeddings', 'topic_text',
               existing_type=sa.TEXT(),
               comment='Original topic description',
               existing_comment='Original topic description used for embedding',
               existing_nullable=False)
    op.drop_index(op.f('ix_title_suggestions_article_id'), table_name='title_suggestions')
    op.create_unique_constraint(op.f('uq_title_suggestions_article_id'), 'title_suggestions', ['article_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_title_suggestions_generated_at'), 'title_suggestions', [sa.literal_column('generated_at DESC')], unique=False)
    op.create_index(op.f('idx_title_suggestions_article_id'), 'title_suggestions', ['article_id'], unique=False)
    op.alter_column('title_suggestions', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Reference to article for which suggestions were generated',
               existing_comment='Article for which suggestions were generated (one-to-one relationship)',
               existing_nullable=False)
    op.drop_index(op.f('ix_seo_suggestions_focus_keyword'), table_name='seo_suggestions')
    op.drop_index(op.f('ix_seo_suggestions_article_id'), table_name='seo_suggestions')
    op.create_unique_constraint(op.f('uq_seo_suggestions_article_id'), 'seo_suggestions', ['article_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_seo_suggestions_focus_keyword'), 'seo_suggestions', ['focus_keyword'], unique=False)
    op.create_index(op.f('idx_seo_suggestions_article_id'), 'seo_suggestions', ['article_id'], unique=False)
    op.alter_column('seo_suggestions', 'suggested_tags',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Array of suggested tags with relevance scores',
               existing_comment='Array of suggested tags with relevance scores and types',
               existing_nullable=True)
    op.alter_column('seo_suggestions', 'suggested_meta_description',
               existing_type=sa.TEXT(),
               comment='AI-optimized meta description (150-160 chars)',
               existing_comment='AI-optimized meta description (150-160 chars recommended)',
               existing_nullable=True)
    op.alter_column('seo_suggestions', 'keyword_difficulty',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment='Difficulty scores for keywords',
               existing_comment='Difficulty scores for keywords (0.0-1.0)',
               existing_nullable=True)
    op.alter_column('seo_suggestions', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Reference to article for which SEO suggestions were generated',
               existing_comment='Article for which SEO suggestions were generated (one-to-one relationship)',
               existing_nullable=False)
    op.drop_index(op.f('ix_seo_metadata_seo_score'), table_name='seo_metadata')
    op.drop_index(op.f('ix_seo_metadata_focus_keyword'), table_name='seo_metadata')
    op.drop_index(op.f('ix_seo_metadata_article_id'), table_name='seo_metadata')
    op.create_unique_constraint(op.f('seo_metadata_article_id_key'), 'seo_metadata', ['article_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_seo_metadata_seo_score'), 'seo_metadata', ['seo_score'], unique=False)
    op.create_index(op.f('idx_seo_metadata_focus_keyword'), 'seo_metadata', ['focus_keyword'], unique=False)
    op.create_index(op.f('idx_seo_metadata_article_id'), 'seo_metadata', ['article_id'], unique=False)
    op.alter_column('seo_metadata', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='When SEO metadata was last updated',
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('seo_metadata', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='When SEO analysis was created',
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('seo_metadata', 'generated_by',
               existing_type=sa.VARCHAR(length=50),
               server_default=sa.text("'claude-3-5-haiku-20241022'::character varying"),
               existing_comment='AI model used for generation',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'manual_overrides',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='User-edited fields tracking',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'optimization_recommendations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'[]'::jsonb"),
               existing_comment='Array of optimization suggestions',
               existing_nullable=True)
    op.alter_column('seo_metadata', 'keyword_density',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='Keyword -> {count, density} mapping',
               existing_nullable=True)
    op.drop_index(op.f('ix_publish_tasks_task_id'), table_name='publish_tasks')
    op.drop_index(op.f('ix_publish_tasks_status'), table_name='publish_tasks')
    op.drop_index(op.f('ix_publish_tasks_provider'), table_name='publish_tasks')
    op.drop_index(op.f('ix_publish_tasks_created_at'), table_name='publish_tasks')
    op.drop_index(op.f('ix_publish_tasks_article_id'), table_name='publish_tasks')
    op.create_unique_constraint(op.f('publish_tasks_task_id_key'), 'publish_tasks', ['task_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_publish_tasks_task_id'), 'publish_tasks', ['task_id'], unique=False)
    op.create_index(op.f('idx_publish_tasks_status'), 'publish_tasks', ['status'], unique=False)
    op.create_index(op.f('idx_publish_tasks_provider'), 'publish_tasks', ['provider'], unique=False)
    op.create_index(op.f('idx_publish_tasks_created_at'), 'publish_tasks', ['created_at'], unique=False)
    op.create_index(op.f('idx_publish_tasks_article_id'), 'publish_tasks', ['article_id'], unique=False)
    op.alter_column('publish_tasks', 'created_at',
               existing_type=sa.DateTime(),
               server_default=sa.text('now()'),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='When task was created',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'completed_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='When task completed (success or failure)',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'started_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='When task execution started',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'screenshots',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'[]'::jsonb"),
               existing_comment='Array of screenshot metadata {url, step, timestamp}',
               existing_nullable=True)
    op.alter_column('publish_tasks', 'max_retries',
               existing_type=sa.INTEGER(),
               server_default=sa.text('3'),
               existing_comment='Maximum retry attempts allowed',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'retry_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Number of retry attempts',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'completed_steps',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Number of completed steps',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'total_steps',
               existing_type=sa.INTEGER(),
               server_default=sa.text('7'),
               existing_comment='Total number of steps in publishing workflow',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'current_step',
               existing_type=sa.VARCHAR(length=100),
               server_default=sa.text("'pending'::character varying"),
               existing_comment='Current step description',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'progress',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Task progress percentage (0-100)',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'status',
               existing_type=sa.Enum('idle', 'pending', 'initializing', 'logging_in', 'creating_post', 'uploading_images', 'configuring_seo', 'publishing', 'completed', 'failed', name='taskstatus'),
               server_default=sa.text("'pending'::task_status_enum"),
               type_=postgresql.ENUM('idle', 'pending', 'initializing', 'logging_in', 'creating_post', 'uploading_images', 'configuring_seo', 'publishing', 'completed', 'failed', name='task_status_enum'),
               existing_comment='Task execution status',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'cms_type',
               existing_type=sa.VARCHAR(length=50),
               server_default=sa.text("'wordpress'::character varying"),
               existing_comment='Target CMS type (wordpress, drupal, etc.)',
               existing_nullable=False)
    op.alter_column('publish_tasks', 'provider',
               existing_type=sa.Enum('playwright', 'computer_use', 'hybrid', name='provider'),
               server_default=sa.text("'playwright'::provider_enum"),
               type_=postgresql.ENUM('playwright', 'computer_use', 'hybrid', name='provider_enum'),
               existing_comment='Computer Use provider (anthropic, gemini, playwright)',
               existing_nullable=False)
    op.create_unique_constraint(op.f('uq_provider_metrics_provider_date'), 'provider_metrics', ['provider', 'date'], postgresql_nulls_not_distinct=False)
    op.alter_column('provider_metrics', 'created_at',
               existing_type=sa.DateTime(),
               server_default=sa.text('now()'),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='Record creation timestamp',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'success_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               server_default=sa.text('0'),
               existing_comment='Success rate percentage (0-100)',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'failed_tasks',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Total failed tasks',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'successful_tasks',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Total successful tasks',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'total_tasks',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               existing_comment='Total tasks executed during interval',
               existing_nullable=False)
    op.alter_column('provider_metrics', 'provider',
               existing_type=sa.Enum('PLAYWRIGHT', 'COMPUTER_USE', 'HYBRID', name='provider'),
               type_=postgresql.ENUM('playwright', 'computer_use', 'hybrid', name='provider_enum'),
               existing_nullable=False)
    op.create_table_comment(
        'proofreading_history',
        '校对执行历史记录表，存储每次校对的执行结果和统计信息',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_proofreading_history_executed_at'), table_name='proofreading_history')
    op.drop_index(op.f('ix_proofreading_history_article_id'), table_name='proofreading_history')
    op.create_index(op.f('idx_proofreading_history_pending_feedback'), 'proofreading_history', ['article_id'], unique=False, postgresql_where='(pending_feedback_count > 0)')
    op.create_index(op.f('idx_proofreading_history_executed_at'), 'proofreading_history', [sa.literal_column('executed_at DESC')], unique=False)
    op.create_index(op.f('idx_proofreading_history_article_id'), 'proofreading_history', ['article_id'], unique=False)
    op.alter_column('proofreading_history', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text('CURRENT_TIMESTAMP'),
               comment=None,
               existing_comment='创建时间',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'executed_by',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='执行者用户ID',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'config_snapshot',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='校对配置快照',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'issues_snapshot',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='校对问题的完整快照',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'ai_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='AI引擎发现的问题数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'deterministic_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='确定性引擎发现的问题数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'pending_feedback_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='待处理反馈的数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'feedback_provided_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='提供反馈的数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'pending_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='待处理的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'modified_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='修改的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'rejected_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='拒绝的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'accepted_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='接受的建议数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'info_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='提示问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'warning_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='警告问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'critical_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='严重问题数量',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'total_issues_found',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='发现的问题总数',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'engine_version',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='引擎版本号',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'execution_duration_ms',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='执行耗时（毫秒）',
               existing_nullable=True)
    op.alter_column('proofreading_history', 'executed_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text('CURRENT_TIMESTAMP'),
               comment=None,
               existing_comment='执行时间',
               existing_nullable=False)
    op.alter_column('proofreading_history', 'article_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联的文章ID',
               existing_nullable=False)
    op.create_table_comment(
        'proofreading_decisions',
        '校对决策记录表，存储用户对校对建议的接受、拒绝或修改决策',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_proofreading_decisions_rule_id'), table_name='proofreading_decisions')
    op.drop_index(op.f('ix_proofreading_decisions_feedback_status'), table_name='proofreading_decisions')
    op.drop_index(op.f('ix_proofreading_decisions_decision_type'), table_name='proofreading_decisions')
    op.drop_index(op.f('ix_proofreading_decisions_decided_at'), table_name='proofreading_decisions')
    op.drop_index(op.f('ix_proofreading_decisions_article_id'), table_name='proofreading_decisions')
    op.create_unique_constraint(op.f('uq_article_suggestion'), 'proofreading_decisions', ['article_id', 'suggestion_id'], postgresql_nulls_not_distinct=False)
    op.create_index(op.f('idx_proofreading_decisions_stats'), 'proofreading_decisions', ['rule_category', 'decision_type', 'decided_at'], unique=False)
    op.create_index(op.f('idx_proofreading_decisions_rule_id'), 'proofreading_decisions', ['rule_id'], unique=False)
    op.create_index(op.f('idx_proofreading_decisions_feedback_status'), 'proofreading_decisions', ['feedback_status'], unique=False, postgresql_where='(feedback_provided = true)')
    op.create_index(op.f('idx_proofreading_decisions_decision_type'), 'proofreading_decisions', ['decision_type'], unique=False)
    op.create_index(op.f('idx_proofreading_decisions_decided_at'), 'proofreading_decisions', ['decided_at'], unique=False)
    op.create_index(op.f('idx_proofreading_decisions_article_id'), 'proofreading_decisions', ['article_id'], unique=False)
    op.alter_column('proofreading_decisions', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('proofreading_decisions', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('CURRENT_TIMESTAMP'))
    op.alter_column('proofreading_decisions', 'decided_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text('CURRENT_TIMESTAMP'),
               comment=None,
               existing_comment='决策时间',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'decided_by',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='决策者用户ID',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'feedback_status',
               existing_type=sa.Enum('pending', 'in_progress', 'completed', 'failed', name='feedbackstatus'),
               server_default=sa.text("'pending'::character varying"),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='反馈状态',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'feedback_notes',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='反馈备注',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'feedback_category',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='反馈类别',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'feedback_provided',
               existing_type=sa.BOOLEAN(),
               server_default=sa.text('false'),
               comment=None,
               existing_comment='是否提供了反馈',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'issue_position',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='问题位置信息',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'rule_category',
               existing_type=sa.VARCHAR(length=10),
               comment=None,
               existing_comment='规则类别',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'rule_id',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='触发的规则ID',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'suggested_text',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='建议文本',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'original_text',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='原始文本',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'modified_content',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='修改后的内容',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'decision_rationale',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='决策理由',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'decision_type',
               existing_type=sa.Enum('accepted', 'rejected', 'modified', name='decisiontype'),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='决策类型',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'proofreading_history_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联的校对历史ID',
               existing_nullable=True)
    op.alter_column('proofreading_decisions', 'suggestion_id',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='建议的唯一标识符',
               existing_nullable=False)
    op.alter_column('proofreading_decisions', 'article_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联的文章ID',
               existing_nullable=False)
    op.create_table_comment(
        'feedback_tuning_jobs',
        '反馈调优任务表，用于批量分析用户反馈并生成规则优化建议',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_feedback_tuning_jobs_status'), table_name='feedback_tuning_jobs')
    op.drop_index(op.f('ix_feedback_tuning_jobs_created_at'), table_name='feedback_tuning_jobs')
    op.create_index(op.f('idx_feedback_tuning_jobs_type_status'), 'feedback_tuning_jobs', ['job_type', 'status'], unique=False)
    op.create_index(op.f('idx_feedback_tuning_jobs_status'), 'feedback_tuning_jobs', ['status'], unique=False)
    op.create_index(op.f('idx_feedback_tuning_jobs_created_at'), 'feedback_tuning_jobs', [sa.literal_column('created_at DESC')], unique=False)
    op.alter_column('feedback_tuning_jobs', 'completed_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='完成时间',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'started_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='开始时间',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text('CURRENT_TIMESTAMP'),
               comment=None,
               existing_comment='创建时间',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'created_by',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='创建者用户ID',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'error_details',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='错误详情',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'error_message',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='错误消息',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'recommendations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='优化建议',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'results',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               comment=None,
               existing_comment='分析结果',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'progress_percent',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='进度百分比',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'status',
               existing_type=sa.Enum('pending', 'running', 'completed', 'failed', name='tuningjobstatus'),
               server_default=sa.text("'pending'::character varying"),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='任务状态',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'processed_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='已处理数量',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'total_decisions_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='总决策数量',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'end_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='结束日期',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'start_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='开始日期',
               existing_nullable=False)
    op.alter_column('feedback_tuning_jobs', 'target_categories',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='目标规则类别列表',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'target_rule_ids',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               comment=None,
               existing_comment='目标规则ID列表',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'job_description',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='任务描述',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'job_name',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='任务名称',
               existing_nullable=True)
    op.alter_column('feedback_tuning_jobs', 'job_type',
               existing_type=sa.Enum('rule_tuning', 'prompt_optimization', 'batch_analysis', name='tuningjobtype'),
               type_=sa.VARCHAR(length=30),
               comment=None,
               existing_comment='任务类型',
               existing_nullable=False)
    op.drop_index(op.f('ix_execution_logs_task_id'), table_name='execution_logs')
    op.drop_index(op.f('ix_execution_logs_log_level'), table_name='execution_logs')
    op.drop_index(op.f('ix_execution_logs_created_at'), table_name='execution_logs')
    op.create_index(op.f('idx_execution_logs_task_id'), 'execution_logs', ['task_id'], unique=False)
    op.create_index(op.f('idx_execution_logs_log_level'), 'execution_logs', ['log_level'], unique=False)
    op.create_index(op.f('idx_execution_logs_created_at'), 'execution_logs', ['created_at'], unique=False)
    op.alter_column('execution_logs', 'created_at',
               existing_type=sa.DateTime(),
               server_default=sa.text('now()'),
               type_=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='When log entry was created (partition key)',
               existing_nullable=False)
    op.alter_column('execution_logs', 'screenshot_url',
               existing_type=sa.VARCHAR(length=500),
               comment=None,
               existing_comment='Associated screenshot URL',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_result',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='Action result (success, failed, timeout)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_target',
               existing_type=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='Target element (CSS selector, URL, etc.)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'action_type',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='Action type (navigate, click, type, upload, screenshot)',
               existing_nullable=True)
    op.alter_column('execution_logs', 'details',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               comment=None,
               existing_comment='Additional structured log data',
               existing_nullable=True)
    op.alter_column('execution_logs', 'message',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='Log message',
               existing_nullable=True)
    op.alter_column('execution_logs', 'step_name',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='Publishing step name',
               existing_nullable=True)
    op.alter_column('execution_logs', 'log_level',
               existing_type=sa.Enum('DEBUG', 'INFO', 'WARNING', 'ERROR', name='loglevel'),
               server_default=sa.text("'INFO'::log_level_enum"),
               type_=postgresql.ENUM('DEBUG', 'INFO', 'WARNING', 'ERROR', name='log_level_enum'),
               comment=None,
               existing_comment='Log severity level',
               existing_nullable=False)
    op.alter_column('execution_logs', 'task_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='Reference to publish task',
               existing_nullable=False)
    op.drop_index(op.f('ix_articles_unified_optimization_generated'), table_name='articles')
    op.drop_index(op.f('ix_articles_status'), table_name='articles')
    op.drop_index(op.f('ix_articles_source'), table_name='articles')
    op.drop_index(op.f('ix_articles_published_url'), table_name='articles')
    op.drop_index(op.f('ix_articles_published_at'), table_name='articles')
    op.drop_index(op.f('ix_articles_author_id'), table_name='articles')
    op.create_index(op.f('idx_articles_unified_optimization_generated'), 'articles', ['unified_optimization_generated'], unique=False, postgresql_where='(unified_optimization_generated = false)')
    op.create_index(op.f('idx_articles_status'), 'articles', ['status'], unique=False)
    op.create_index(op.f('idx_articles_source'), 'articles', ['source'], unique=False)
    op.create_index(op.f('idx_articles_published_url'), 'articles', ['published_url'], unique=False)
    op.create_index(op.f('idx_articles_published'), 'articles', ['published_at'], unique=False, postgresql_where='(published_at IS NOT NULL)')
    op.create_index(op.f('idx_articles_parsing_confirmed_at'), 'articles', [sa.literal_column('parsing_confirmed_at DESC')], unique=False)
    op.create_index(op.f('idx_articles_parsing_confirmed'), 'articles', ['parsing_confirmed'], unique=False, postgresql_where='(parsing_confirmed = false)')
    op.create_index(op.f('idx_articles_metadata'), 'articles', ['article_metadata'], unique=False, postgresql_using='gin')
    op.create_index(op.f('idx_articles_author'), 'articles', ['author_id'], unique=False)
    op.alter_column('articles', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('articles', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('articles', 'formatting',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               comment='Formatting preferences',
               existing_comment='Formatting preferences (headings, lists, code blocks)',
               existing_nullable=False)
    op.alter_column('articles', 'article_metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               comment='CMS-specific metadata',
               existing_comment='CMS-specific metadata (featured image, excerpt, etc.)',
               existing_nullable=False)
    op.alter_column('articles', 'unified_optimization_cost',
               existing_type=sa.Numeric(precision=10, scale=6),
               type_=sa.NUMERIC(precision=10, scale=4),
               existing_comment='Cost in USD for generating all optimizations',
               existing_nullable=True)
    op.alter_column('articles', 'unified_optimization_generated',
               existing_type=sa.BOOLEAN(),
               server_default=sa.text('false'),
               comment='Whether unified optimization (title+SEO+FAQ) has been generated',
               existing_comment='Whether unified AI optimizations have been generated',
               existing_nullable=False)
    op.alter_column('articles', 'published_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='Actual publication timestamp',
               existing_nullable=True)
    op.alter_column('articles', 'seo_keywords',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_comment='Array of SEO keywords extracted from content',
               existing_nullable=True)
    op.alter_column('articles', 'suggested_seo_keywords',
               existing_type=postgresql.ARRAY(sa.VARCHAR()),
               comment=None,
               existing_comment='AI-suggested SEO keywords array',
               existing_nullable=True)
    op.alter_column('articles', 'critical_issues_count',
               existing_type=sa.INTEGER(),
               server_default=sa.text('0'),
               comment=None,
               existing_comment='Count of blocking (F-class) issues',
               existing_nullable=False)
    op.alter_column('articles', 'proofreading_issues',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'[]'::jsonb"),
               comment=None,
               existing_comment='Combined AI/script proofreading issues',
               existing_nullable=False)
    op.alter_column('articles', 'additional_images',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'[]'::jsonb"),
               existing_comment='Array of additional image paths',
               existing_nullable=True)
    op.alter_column('articles', 'source',
               existing_type=sa.VARCHAR(length=50),
               server_default=sa.text("'manual'::character varying"),
               existing_comment='Article import source (csv_import, json_import, manual, wordpress_export)',
               existing_nullable=False)
    op.alter_column('articles', 'status',
               existing_type=postgresql.ENUM('draft', 'in-review', 'scheduled', 'published', 'failed', 'imported', 'seo_optimized', 'ready_to_publish', 'publishing', name='articlestatus'),
               server_default=sa.text("'draft'::articlestatus"),
               existing_comment='Workflow status',
               existing_nullable=False)
    op.alter_column('articles', 'body',
               existing_type=sa.TEXT(),
               comment='Full article content',
               existing_comment='Full article content (Markdown or HTML)',
               existing_nullable=False)
    op.drop_column('articles', 'suggested_titles')
    op.alter_column('article_status_history', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text("timezone('utc'::text, now())"),
               comment=None,
               existing_comment='Timestamp when the status change occurred',
               existing_nullable=False)
    op.alter_column('article_status_history', 'metadata',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               comment=None,
               existing_comment='Structured metadata describing the transition context',
               existing_nullable=False)
    op.alter_column('article_status_history', 'change_reason',
               existing_type=sa.VARCHAR(length=255),
               comment=None,
               existing_comment='Optional description of why the transition occurred',
               existing_nullable=True)
    op.alter_column('article_status_history', 'changed_by',
               existing_type=sa.VARCHAR(length=100),
               comment=None,
               existing_comment="User id or 'system' for automated transitions",
               existing_nullable=True)
    op.alter_column('article_status_history', 'new_status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='New article status value',
               existing_nullable=False)
    op.alter_column('article_status_history', 'old_status',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='Previous article status value',
               existing_nullable=True)
    op.create_table_comment(
        'article_images',
        'Stores structured information about images extracted from articles',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_article_images_article_id'), table_name='article_images')
    op.create_index(op.f('idx_article_images_position'), 'article_images', ['article_id', 'position'], unique=False)
    op.create_index(op.f('idx_article_images_metadata_gin'), 'article_images', ['metadata'], unique=False, postgresql_using='gin')
    op.create_index(op.f('idx_article_images_created_at'), 'article_images', [sa.literal_column('created_at DESC')], unique=False)
    op.create_index(op.f('idx_article_images_article_id'), 'article_images', ['article_id'], unique=False)
    op.alter_column('article_images', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='Record last update timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('article_images', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='Record creation timestamp',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.create_table_comment(
        'article_image_reviews',
        'Tracks reviewer feedback and actions on individual images during parsing confirmation',
        existing_comment=None,
        schema=None
    )
    op.drop_index(op.f('ix_article_image_reviews_worklist_item_id'), table_name='article_image_reviews')
    op.drop_index(op.f('ix_article_image_reviews_created_at'), table_name='article_image_reviews')
    op.drop_index(op.f('ix_article_image_reviews_article_image_id'), table_name='article_image_reviews')
    op.drop_index(op.f('ix_article_image_reviews_action'), table_name='article_image_reviews')
    op.create_index(op.f('idx_article_image_reviews_worklist_item'), 'article_image_reviews', ['worklist_item_id'], unique=False)
    op.create_index(op.f('idx_article_image_reviews_created_at'), 'article_image_reviews', [sa.literal_column('created_at DESC')], unique=False)
    op.create_index(op.f('idx_article_image_reviews_article_image'), 'article_image_reviews', ['article_image_id'], unique=False)
    op.create_index(op.f('idx_article_image_reviews_action'), 'article_image_reviews', ['action'], unique=False)
    op.alter_column('article_image_reviews', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               server_default=sa.text('now()'),
               comment=None,
               existing_comment='Timestamp when review was created',
               existing_nullable=False)
    op.alter_column('article_image_reviews', 'action',
               existing_type=sa.Enum('keep', 'remove', 'replace_caption', 'replace_source', name='imagereviewaction'),
               type_=sa.VARCHAR(length=20),
               existing_comment='Action taken: keep|remove|replace_caption|replace_source',
               existing_nullable=False)
    op.drop_index(op.f('ix_article_faqs_status'), table_name='article_faqs')
    op.drop_index(op.f('ix_article_faqs_article_id'), table_name='article_faqs')
    op.create_index(op.f('idx_article_faqs_status'), 'article_faqs', ['status'], unique=False)
    op.create_index(op.f('idx_article_faqs_position'), 'article_faqs', ['article_id', 'position'], unique=False)
    op.create_index(op.f('idx_article_faqs_article_id'), 'article_faqs', ['article_id'], unique=False)
    op.alter_column('article_faqs', 'status',
               existing_type=sa.Enum('DRAFT', 'APPROVED', 'REJECTED', 'PUBLISHED', name='faq_status'),
               type_=sa.VARCHAR(length=20),
               existing_comment='Status: draft, approved, rejected, published',
               existing_nullable=False,
               existing_server_default=sa.text("'draft'::character varying"))
    op.alter_column('article_faqs', 'search_intent',
               existing_type=sa.Enum('INFORMATIONAL', 'NAVIGATIONAL', 'TRANSACTIONAL', name='faq_search_intent'),
               type_=sa.VARCHAR(length=20),
               existing_comment='Intent: informational, navigational, transactional',
               existing_nullable=True)
    op.alter_column('article_faqs', 'question_type',
               existing_type=sa.Enum('FACTUAL', 'HOW_TO', 'COMPARISON', 'DEFINITION', name='faq_question_type'),
               type_=sa.VARCHAR(length=20),
               existing_comment='Type: factual, how_to, comparison, definition',
               existing_nullable=True)
    op.alter_column('article_faqs', 'article_id',
               existing_type=sa.INTEGER(),
               comment='Reference to article for which FAQ was generated',
               existing_comment='Article this FAQ belongs to (one-to-many relationship)',
               existing_nullable=False)
    op.alter_column('app_settings', 'updated_at',
               existing_type=sa.DateTime(),
               server_default=sa.text('now()'),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_comment='Last update timestamp',
               existing_nullable=False)
    op.alter_column('app_settings', 'screenshot_retention',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='Screenshot retention policies (count, duration)',
               existing_nullable=False)
    op.alter_column('app_settings', 'cost_limits',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='Cost thresholds and budgeting rules',
               existing_nullable=False)
    op.alter_column('app_settings', 'cms_config',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='CMS connection details and preferences',
               existing_nullable=False)
    op.alter_column('app_settings', 'provider_config',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               server_default=sa.text("'{}'::jsonb"),
               existing_comment='Publishing provider configuration (playwright/computer_use/hybrid)',
               existing_nullable=False)
    op.create_table('execution_logs_2025_11',
    sa.Column('id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.Column('task_id', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('log_level', postgresql.ENUM('DEBUG', 'INFO', 'WARNING', 'ERROR', name='log_level_enum'), server_default=sa.text("'INFO'::log_level_enum"), autoincrement=False, nullable=False),
    sa.Column('step_name', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('details', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('action_type', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('action_target', sa.VARCHAR(length=200), autoincrement=False, nullable=True),
    sa.Column('action_result', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('screenshot_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['task_id'], ['publish_tasks.id'], name=op.f('execution_logs_task_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', 'created_at', name=op.f('execution_logs_2025_11_pkey'))
    )
    op.create_index(op.f('execution_logs_2025_11_task_id_idx'), 'execution_logs_2025_11', ['task_id'], unique=False)
    op.create_index(op.f('execution_logs_2025_11_log_level_idx'), 'execution_logs_2025_11', ['log_level'], unique=False)
    op.create_index(op.f('execution_logs_2025_11_created_at_idx'), 'execution_logs_2025_11', ['created_at'], unique=False)
    op.create_table('execution_logs_2025_10',
    sa.Column('id', sa.BIGINT(), autoincrement=True, nullable=False),
    sa.Column('task_id', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('log_level', postgresql.ENUM('DEBUG', 'INFO', 'WARNING', 'ERROR', name='log_level_enum'), server_default=sa.text("'INFO'::log_level_enum"), autoincrement=False, nullable=False),
    sa.Column('step_name', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('details', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('action_type', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('action_target', sa.VARCHAR(length=200), autoincrement=False, nullable=True),
    sa.Column('action_result', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('screenshot_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['task_id'], ['publish_tasks.id'], name=op.f('execution_logs_task_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', 'created_at', name=op.f('execution_logs_2025_10_pkey'))
    )
    op.create_index(op.f('execution_logs_2025_10_task_id_idx'), 'execution_logs_2025_10', ['task_id'], unique=False)
    op.create_index(op.f('execution_logs_2025_10_log_level_idx'), 'execution_logs_2025_10', ['log_level'], unique=False)
    op.create_index(op.f('execution_logs_2025_10_created_at_idx'), 'execution_logs_2025_10', ['created_at'], unique=False)
    # ### end Alembic commands ###
